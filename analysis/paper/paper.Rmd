---
title: "Investigating shape standardisation using geometric morphometry of pottery from Iron Age northeastern Taiwan"
author:
  - Li-Ying Wang
  - Ben Marwick
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  The emergence of ceramic specialization in prehistoric societies is often linked to shifts in the complexity of social structures, because specialized pottery production can reflect craft specialization and the presence of elite control. Previous work on identifying specialization relies on typological or linear metric analysis. Here we demonstrate how to investigate ceramic standardization by analyzing outlines of ceramic vessels. Outline analysis is useful because, unlike more commonly-used landmark analysis methods, it can effectively quantify shape differences for objects that lack distinctive measurement points needed for landmark analysis. We demonstrate this method using pottery from Kiwulan, a large multi-component Iron Age site (AD 1350-1850) in northeastern Taiwan. To measure ceramic specialization, we quantified pottery standardization by analyzing shape variables with reproducible geometric morphometric methods. We computed coefficients of variation (CVs) for shape coefficients obtained by elliptical Fourier analysis to test for shape standardization. We found significant differences in pottery shape and shape standardization that indicate changes in pottery production resulting from contact with mainland Han Chinese groups in northeastern Taiwan. Our case study, which includes an openly available research compendium of R code, represents an innovative application of outline-based methods in geometric morphometry to answer the anthropological questions of craft specialization. 
keywords: |
  Geometric Morphometrics; craft specialization; Iron age; culture contact; ceramic standardization
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  dpi = 300,
  fig.path = "../figures/"
)

image_width_1_col_inch = 90/25.4 # image Single column	w = 90 mm 
image_width_2_col_inch = 190/25.4 # image Double column w = 190 mm 
```

# Introduction

A major historical factor that is often linked to social change in small-scale societies is colonial settlers introducing foreign trade goods to local Indigenous societies. The monopolization of long-distance trade goods has caused substantial transformations of Indigenous economic, cultural, and socio-political systems (Dietler, 2005, 1997; Junker, 1993; Silliman, 2005). Pericolonial archaeology is the study of these indirect effects of colonialism, investigating areas where direct European colonial rule was limited, their conquests often short-lived and unsuccessful, but their commercial activities had economic and political impacts on Indigenous peoples living on the periphery of colonial control (Acabado, 2017; Trabert, 2017). Pericolonial situations were common during the seventeenth to nineteenth centuries in East and Southeast Asia where European trading activity was extensive, but direct European rule less widespread. An emerging priority in archaeological research in this region is identifying the indirect influences are apparent on Indigenous communities during this time. For example, Acabado (2017)’s study of Ifugao society in the Philippines highland suggests economic and political intensification during the Spanish presence as the response of Indigenous peoples to the Spanish cooptation. 

Indigenous societies’ responses to colonial contact range from passive acceptance through to active negotiation with the colonists, and accommodation or resistance of foreign intrusion. These responses can be identified through their daily cultural practices, such as their consumption patterns of foreign goods (Dietler, 2015; Given, 2004; Mullins, 2011; Scaramelli and Scaramelli, 2005; Silliman, 2001; Torrence and Clarke, 2000). In this paper we investigate the archaeology of a pericolonial situation at Kiwulan (1350-1950 AD), a large multi-component archaeological site in Yilan Province, northeastern Taiwan (Chen, 2007), to identify the indirect impacts of colonial settler activity on local Indigenous societies. Yilan is an ideal context to study peripheral colonial influences because Indigenous communities there were isolated by geographical barriers that limited the frequency of direct contact with the Spanish and the Dutch settlers in northern Taiwan. Kiwulan is situated on a hill near a riverside at the northern margin of Yilan County, which is characterized by a triangular alluvial plain facing eastwards the Pacific with high mountains on three other sides. 

Our specific aim is to investigate if there was increasing ceramic specialization resulting from Indigenous interaction with Europeans in the 17th century or Chinese in the 19th century, two major foreign influences in early historical Taiwan, that might indicate social changes in local Indigenous societies. We predict that competition within the Indigenous community at Kiwulan for foreign resources and trade partnerships with European or Chinese colonizers may have led to the emergence of craft specialization caused by greater economic and social control of pottery production by a small group of individuals. Using pottery shape as a proxy to study craft specialization, we ask: Did colonial trade impact the shape of locally-produced Indigenous pottery vessels? Did pottery shape become more homogeneous and standardized after foreign contacts with European colonizers or Chinese immigrants?

Several measurements have been used for investigating ceramic standardization, such as metric, compositional, and technological variables (Arnold, 2000; Blackman et al., 1993; Boness et al., 2015; Costin, 1991; Rice, 1991; Roux, 2015; Tite, 1999). Among those variables, metric measurements are most widely applied to archaeological assemblages because of the ease of collecting these data. The coefficient of variation statistic is commonly used to quantify the degree of standardization in ceramic assemblages (Eerkens and Bettinger, 2001; Roux, 2003; Stark, 1995b). However, because pottery vessels typically have curved shapes, linear measurements have limited sensitivity to many kinds of shape variations. Thus, to capture subtle shape variations that might also be relevant to standardization, we analyze pottery shape using geometric morphometric methods. 

## Geometric Morphometry

Geometric morphometrics differs from traditional linear measurements through its use of Cartesian coordinates of morphological structures to define shapes (Adams et al., 2004; Bookstein, 1997; Lawing and Polly, 2010; Slice, 2007). Landmarks, curves or outlines of objects can be represented by coordinates in terms of their unique point locations with respect to numerical values on coordinate axes. There are two common morphometric methods: landmark approaches and outline approaches (Adams et al., 2004). Landmark approaches assign a set of landmarks or semilandmarks onto objects as reference points that can be specified on a coordinate system. Landmark-based morphometrics are widely applied to archaeological objects with obvious morphological features that can provide unambiguous reference points for landmark placement, such as projectile point tips or visually distinctive osteological features (Birch and Martinón-Torres, 2019; Buchanan et al., 2019; Cardillo, 2010; Haruda et al., 2019; Lycett and Cramon-Taubadel, 2013; Meloro et al., 2015).

However, a key limitation of the landmark approach is that landmarks may be difficult to reproducibly locate for structures that are mostly or entirely curves. In those cases, outline approaches are more suitable for analyzing the overall shape of an object. One outline approach is the semi-landmarks method, also called sliding landmarks, which assigns points along the curve between two landmarks at defined intervals (Bookstein, 1997; Lawing and Polly, 2010). Those semi-landmarks are allowed to slide along the curve to remove the effect of the arbitrary landmark spacing by minimizing either Procrustes distance or bending energy (Bookstein, 1997; Gunz and Mitteroecker, 2013; Slice, 2007). Another approach that is commonly applied to two-dimensional closed shapes is elliptic Fourier Analysis (EFA), that converts coordinates along a curve into Fourier function coefficients, called harmonic coefficients (Kuhl and Giardina, 1982). EFA uses periodic functions to capture geometric information, where an outline is decomposed into a series of ellipses described by trigonometric functions (Adams et al., 2004; Bonhomme et al., 2014; Claude, 2008). The number of harmonics determines the quality and precision of the geometric representation of an object. The harmonic power, a cumulated sum of squared harmonic coefficients, provides a robust rule for determining the desired number of harmonics (Bonhomme et al., 2014). EFA is suitable for shapes lacking representative landmarks or where curves contain the most meaningful variation. Applications in archaeology include human remains and zooarchaeology, stone artifacts, and ceramics (Fox, 2015; Hoggard et al., 2019; Ioviţă, 2010; Topi et al. 2018; Selden Jr 2019; Wilczek et al. 2014). Taking the ceramics data from Kiwulan, northeastern Taiwan, we use EFA to evaluate the level of standardization of ceramics in relation to the European presence in the 17th century to get insights into the emergence of ceramic specialization. We use a significance test for the equality of coefficient of variations of shape variables to statistically compare the vessel standardization from different periods. 


# Archaeological background and materials 

Ceramics analyzed in this paper come from 40 units (4m by 4m each) sampled from the central, undisturbed area of archaeological excavations at Kiwulan (Figure 1; Figure 2). The chronology of the archaeological deposits at Kiwulan consists of two cultural components, the upper component and the lower component, with a sterile layer in between (Chen, 2007). This paper focuses on the upper component, dated from AD 1350 to AD 1950, covering the late Iron Age and the historical period, which we define as the European occupation in Taiwan in the early 17th century. The Dutch first occupied southern Taiwan in 1624 and then the Spanish occupied northern Taiwan in 1626 (Andrade, 2007). In 1642, the Spanish was expelled by the Dutch in northern Taiwan, who took over their forts at Helping Dau in Keelung, and in Tamsui. Since then, western Taiwan was mostly under Dutch colonial rule until 1662 when the Kingdom of Tungning in Taiwan was founded by Koxinga, a loyalist of the Ming dynasty of China (Andrade, 2007). 

```{r, KWL-map, fig.cap = "Map showing the location of Kiwulan, and other places in northern Taiwan named in the text. Map data from naturalearthdata.com", fig.width=image_width_2_col_inch}
library(here)
knitr::include_graphics(here("analysis", "figures", "kiwulan-location-map.jpg"))
```

```{r, KWL-sam-area, fig.cap = "Map showing the largest section of excavation areas at Kiwulan, and the distribution of forty squares sampled in this paper presented in red with square ID number. Small dots represent the location of post-holes. Each square is 4 x 4 m", fig.width=image_width_2_col_inch}
knitr::include_graphics(here("analysis", "figures", "KWL-excavation-map.jpg"))
```

The archaeological record of Kiwulan's upper component shows traces of foreign contacts, including Europeans in the 17th century, and waves of Chinese immigrants in the 19th century. Imported ceramics from mainland China, stoneware, and ornaments such as beads have been found in the upper component, indicating frequent long-distance trade activities with Europeans and Chinese merchants. In addition to artifacts, archaeological features such as burials, middens, and post-holes with _in-situ_ posts are widespread across the 1-2 m thick deposit of the upper component, and demonstrate that Kiwulan was a continuously occupied large settlement site [@Chen2007]. To compare different foreign influences, we classified the upper component into three chronological phases: the pre-European, European, and Chinese periods. We identified these phases using 32 previously published radiocarbon ages [@Chen2007], excavation depth measurements, stratigraphic details reported by the excavators (color, texture, disturbance, etc.), and finds of chronologically diagnostic artifacts, such as blue and white porcelains, light grey glazed jars, and large dark brown glazed stoneware jars commonly used in the 17th century, and bricks and tiles used by the Chinese in the 19th century [@Chen2007; @Hsieh2009; @Wang2011]. The deposit shows signs of continuous human occupation during each of the three phases across the sampling area.

The most abundant artifacts in the upper component are locally made ceramics, which are distributed throughout the sequence and across the site. More than 550,000 sherds were excavated, and around 1,200 vessels could be partially reconstructed (i.e. complete rim, or complete base). There are only two forms of local vessels, a cooking pot and a steamer made of two cooking pots stacked together with a clay filter layer in between. Those pots forms show high consistency in shape. They have a globular body with a short neck and wide mouth. The exterior surface below the neck is decorated with a wide variety of impressed geometric motifs. These vessels were probably used for cooking, with evidence of charred residues and carbon deposits frequently observed on vessel interiors and soot on their exteriors. They are fired to orange to brownish color with a fully oxidized core or a reduced core with oxidized fringes. Finger impressions and seams usually on the interior indicate they were pinched using slabs of clay and shaped by hand. This kind of pot has been widely found at archaeological sites during the late Iron Age and the historical period throughout the Yilan Plain.

Petrographic analysis for 34 thin sections shows high percentage of inclusions (15-50%), including argillite (15-40%), metasandstone (1-10%),  sandstone fragments (1-6%), quartz (1-5%), and trace amounts of feldspar and slate. The size of the particles ranges from 500 micron to 1300 micron. In general, the globular vessel fabric presents a mixture of fine, rounded argillite with a small part of rounded metasandstone and rounded to sub-angular monocrystalline quartz. The composition matches the mineralogical composition of local raw materials in the Yilan Plain [@Chen2016]. There are no substantial changes in the inclusions over time, indicating continuity in pottery fabric composition across the three periods. 

```{r tidy-data}
# Once we have the jpgs, start from here
library(tidyverse)

# read in pottery data
pottery_data <- readr::read_csv(here("analysis/data/raw_data/KWL_Ceramic_final2018_with_phases.csv"))

# get list of jpgs only
jpgs <- list.files(here("analysis/data/raw_data/outline_jpg"), pattern = ".jpg", full.names = TRUE)

# join file names to phase
pottery_data <- pottery_data %>% 
  mutate(filename = str_glue('fill_{filename}.svg_output.jpg'))

# some outlines that we have no phases for... 
sdiff <- setdiff(pottery_data$filename, basename(jpgs))

# the ones we do have both outlines and phases
isect <- intersect(pottery_data$filename, basename(jpgs))

jpgs <- jpgs[basename(jpgs) %in% isect]
pottery_data <- 
  pottery_data %>% 
  filter(filename %in% isect) %>% 
  distinct(filename, phase, .keep_all = TRUE)

phases_isect <- 
  pottery_data %>%  
  dplyr::select(filename, phase) %>% 
  filter(filename %in% isect) %>% 
  mutate_all(as.factor) %>% 
  distinct(filename, phase) %>% 
  mutate(phase = as.factor(case_when(
    phase == 'post-e' ~ "Post-European", # include European period and after it before Chinese contact
    phase == 'pre-e' ~ "Pre-European",
    phase == 'ch-con' ~ "Chinese" # we can combine Chinese and post-Euro
  ))) 

# how many pots in each phase?
phase_fre <- phases_isect %>% 
  group_by(phase) %>% 
  tally(sort = T)

total_no <- sum(phase_fre$n)
pre_no <- phase_fre$n[1]
Euro_no <- phase_fre$n[2]
Chi_no <- phase_fre$n[3]

# read metric data
kwl_p_ave <- readr::read_csv(here("analysis", "data", "raw_data", "KWL-pottery-metrics-tidy-ave.csv"))

# number for each phase 
kwl_p_ave_total <-
  kwl_p_ave %>% 
  count(period)

# inline code later in the paper
metric_all <- sum(kwl_p_ave_total$n)
pre <- kwl_p_ave_total$n[3]
euro <- kwl_p_ave_total$n[2]
chi <- kwl_p_ave_total$n[1]
```

# Methods

We used all `r total_no` vessels that could be reconstructed with rim, body and base parts and securely provenanced to pre-contact contexts (n = `r pre_no`), post-European contexts (n = `r Euro_no`), and Chinese contact contexts (n = `r Chi_no`) for elliptic Fourier analysis. 

## Digitising and analysing by EFA

drawings present a two-dimensional view of vessel cross-sections with indications of metric measurements. The scanned drawings were imported into Inkscape (http://inkscape.org) where outlines were traced manually. Where only half cross-section images were available, these were duplicated, flipped, and then joined with another one to create a 2D closed outline for each vessel. Geometric morphometric analyses were conducted using the R software (R Core Team, 2019) and the functions included in the Momocs, a R package intended to quantify and analyze shapes (Bonhomme et al., 2014). The digilized outlines were converted into a list of successive xy pixel coordinates for elliptic Fourier analysis (EFA). The harmonic coefficients generated by EFA were analyzed by principal component analysis (PCA) for dimensionality reduction to illustrate the diversity of the shape data and identify major patterns of variation. 

## Statistical analysis 

The principal component (PC) scores were analyzed with a multivariate analysis of variance (MANOVA) test to identify significant differences in shapes between occupation phases. We also computed coefficients of variation values (CVs) for the PCs, treating the PCs as shape variables that are more informative than linear dimensions. The coefficient of variation is a common and widely-used statistical measure of the spread of a set of measurements of a sample. It is defined as the standard deviation divided by the mean:

$$c_v = \frac{\sigma}{\mu}$$

As a standardized measure of the spread of data, coefficients of variation (CV) allow us to directly compare variation in samples measured with different units or means. This is useful to compare the degree of standardization for archaeological assembles and enables comparison of variation across different sample sizes (Eerkens and Bettinger, 2001, p. 498). Following [citations of previous work that has used CVs like this] we take this as our measurement of standardization in vessel shape variables: lower CV values reflect higher standardization, and thus increased craft specialization in the community. Given that CV is robust for positive values due to the representation by ratio, we normalized PC scores to a range between 0 and 1 before computation of CV

To answer the question of whether CV values for vessel samples across our three occupational phases are significantly different or not, we used the Modified signed-likelihood ratio (MSLR) test for equality of CVs [@Krishnamoorthy2014]. While previous work has used the @Feltz1996 asymptotic test for the equality of coefficients of variation from k populations [@Lycett2008; @Okumura2014; @Eerkens2000; @Eerkens2001; @Hoggard2017], we prefer the MSLR test for shape variables as a more recent development with lower rates of type I error, better performance with uneven sample numbers, and more power across a range of conditions [@Krishnamoorthy2014]. 

To complement our investigation of craft specialization through shape standardization, we investigated spatial patterns of ceramic vessels at Kiwulan. As craft specialization increases, pottery distribution we expect a shift from a pattern of vessels dispersed across the site to a pattern of clusters that reflects the loci of production (Costin, 2001). We used a Monte Carlo test for randomness in spatial locations of pots to explore whether their distribution is significantly clustered or dispersed. 

# Reproducibility and open source materials 

To enable re-use of materials and improve reproducibility and transparency [@Marwick2017], the entire R code [@Rlanguage2019] used for all the analysis and visualizations contained in this paper is openly available online at https://doi.org/10.17605/OSF.IO/ABVGF. Also in this version-controlled compendium [@Marwick2018] are the raw data for all the visualizations and tests reported here. All of the figures, tables, and statistical test results presented here can be independently reproduced with the code and data in this repository. The code is released under the MIT license, the data as CC-0, and figures as CC-BY, to enable maximum re-use. 

# Results

```{r pottery-spatial-pattern, fig.cap= "The spatial distribution of the pottery selected for shape analysis. The quantity is indicated by the color scale."}
library(sf)
library(viridis)

# read in the spatial data
AD_zone <- invisible(st_read(here("analysis", "data", "raw_data", "AD_zone.shp"), quiet = TRUE))
units_40 <- invisible(read.csv(here("analysis", "data", "raw_data", "kwl-list-of-sampling-squares.csv")))

AD_zone_tidy <-
  AD_zone %>% 
  mutate(Pit =paste0("P0",Id)) %>% 
  inner_join(units_40, by = c("Pit" = "the_sq")) %>% 
  select(Pit, geometry)

# tidy pottery data
pottery_count <-
  pottery_data %>% 
  select(Site, Context, Pit, Layer, No., phase) %>% 
  count(Pit, phase)

# join two dataset to get coordinate
pottery_count_join <-
  pottery_count %>%
  mutate(phase = as.factor(phase)) %>% # seems need this line first
  inner_join(AD_zone_tidy) %>% 
  filter(!is.na(phase)) %>% 
  mutate(phase = case_when(
    phase %in% "pre-e"~ "Before European Contact",
    phase %in% "post-e" ~ "European Presence",
    phase %in% "ch-con" ~ "Chinese Presence")) %>% 
  mutate(phase = factor(phase,
                        level = c("Before European Contact",
                                  "European Presence",
                                  "Chinese Presence")))
# plot spatial pattern for pottery
plot_spatial_distribution_pottery_by_phase <- 
  ggplot() +
  geom_sf(data = AD_zone_tidy, fill = NA) +
  geom_sf(data = pottery_count_join, 
          aes(geometry = geometry, 
              fill =n), 
          alpha = 0.9)+
  facet_wrap(~ phase) +
  labs(fill = "frequency") +
  scale_fill_viridis(direction = -1) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        strip.text.x = element_text(size = 6),
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 6),
        legend.key.size =  unit(3, "mm"))

plot_spatial_distribution_pottery_by_phase

ggsave(plot = plot_spatial_distribution_pottery_by_phase,
       here("analysis", "figures",
            "plot-spatial-distribution-pottery-by-period.jpg"),
       width = 135, 
       height = 31,
       dpi = 300,
       units = "mm")
```

```{r jpg-coordinates, eval=FALSE}
# start shape exploration
library(Momocs)
#  it freezes on the empty ones...
jpgs_imported <- import_jpg(jpgs, threshold = 0.5)

# Normalise the shapes, from 
# https://www.repository.cam.ac.uk/bitstream/handle/1810/266423/Supplementary%20Code%20S1.pdf?sequence=20&isAllowed=y
jpgs_imported_coo <- 
  jpgs_imported %>% 
   Out(., fac = phases_isect)  %>% 
  # Centring, scaling and sampling pseudo-landmarks
   coo_center %>% 
   coo_scale %>% 
   coo_sample(., 1000) %>% 
  # Procrustes superimposition for pseudo-landmarks
   fgProcrustes %>% 
  # Normalization of the starting points
   coo_slidedirection

saveRDS(jpgs_imported_coo,
        here("analysis/data/derived_data/jpgs_imported_coo.rds"))
```

<!-- basic description of shape -->

We found that 13 harmonics captured 99% of the total harmonic power in our elliptic Fourier coefficients of `r total_no` vessels from three phases. Figure \@ref(fig:thin-plate-splines) shows vessel shape changes described using thin-plate spline warping for paired periods, pre- and post-European periods, and post-European and Chinese periods, with the most greatest differences between pre-European and Chinese periods.

```{r thin-plate-splines, fig.cap= "Comparison of average vessel shapes across phases using thin plate splines (TPS) with outline deformations required to pass from an extreme of one morphospace to another."}
# Thin plate spline analysis (TPS)
# visualize the outline deformations required to pass from an extreme of the morphospace to the other
# Deformation grids

# Mean pottery shapes of three phases
library(Momocs)
library(cowplot)
jpgs_imported_coo <- readr::read_rds(here("analysis/data/derived_data/jpgs_imported_coo.rds"))

# default is 13 harmonics that gather 99% of the harmonic power
op <- efourier(jpgs_imported_coo, norm = FALSE, 13)


# mean shape, per group
pot.ms <- MSHAPES(op, 'phase')
mshp <- pot.ms$shp
names(mshp) <- c("chi", "poe", "pre")

`Post-European` <- mshp$poe
`Pre-European` <-  mshp$pre
`Chinese` <-       mshp$chi

par(mfrow=c(1,2)) # plot them side by side

tps_grid(`Pre-European`, `Post-European`, shp.lwd = c(2, 2), shp.border = c("red", "blue"),
           amp = 1, grid.size = 18, legend = T)

tps_grid(`Pre-European`, `Chinese`, shp.lwd = c(2, 2), shp.border = c("red", "blue"),
           amp = 1, grid.size = 18, legend = T)

# Isodeformation lines
png(here("analysis/figures/tps-iso.png"), res = 600, w = 1200, h = 1800)

#knitr::include_graphics(here::here("analysis", "figures", "tps-pre-Euro-to-post-Euro.png"))
```

```{r PCA-table}
# these are fast
op.p <- PCA(op)
# proportion of variances explained, PC1 and PC2 explain 79% of variation
pro_vari <-scree_plot(op.p)$data
pc1 <- round(pro_vari$proportion[1],4)*100
pc3 <- round(pro_vari$proportion[3],4)*100
vari_two <- round(pro_vari$cumsum[2],4)*100
vari_three <- round(pro_vari$cumsum[3],4)*100
```

<!-- further description of shape and differences between phases -->

The elliptic Fourier coefficients were examined by Principal Components Analysis to explore the shape variations across three phases. The first two principal components (PCs) explain `r vari_two`% of the total variances, of which `r pc1`% is explained by the first principle component. With the third component, the first three principal components explain `r vari_three`% of the total variance. According to Figure \@ref(fig:first-two-PCs-byplot), PC1 captures the height of the vessels, from tall to short, and the roundness of the body from round to oval-shaped. PC2 relates to the neck and mouth constriction, from narrow to wide. PC3 explains a smaller portion of the variance (`r pc3`%), which relates to the degree of the flare of the neck, from curved to straight shape. The first two components account for most of the variance in relation to three phases. The results reflect a large overlap in shapes from three occupations phases, especially for shapes in the pre-European and post-European periods. However, the spread of shape distribution indicates a wider variation in shapes in the pre-European and post-European periods compared to those in the Chinese period along both PC1 and PC2 axes. In other words, we find a decrease in shape variance in the Chinese period that is evident in the shorter height and narrower mouth of vessels used in that period.

```{r first-two-PCs-byplot, fig.cap= "Pottery shape distribution by each occupation phase according to the first two PCs"}

# PCA byplot
plot_PCA(op.p, ~phase, chullfilled = TRUE)
```

```{r MANOVA-table}
# MANOVA: Multivariate Analysis of (co)variace
# We can test for a difference in the distribution of PC scores by calculating a pairwise combination between every levels of a fac. 

manv <- rrtools:::quietly ( MANOVA_PW(op.p, "phase") ) 
su_manv <- as.data.frame(manv$summary)

su_manv_tab <- 
  su_manv %>% 
  mutate_all(round, 4) %>% 
  select(-Df, -`num Df`) %>% 
  rename(`Pillai's trace` = Pillai,
         `Approximate F value` = `approx F`,
         `degrees of freedom` = `den Df`)

pval_chi_pre <- signif(unname(su_manv_tab[,'Pr(>F)'][2]), 4)
pval_post_pre <- signif(unname(su_manv_tab[,'Pr(>F)'][3]), 4)

knitr::kable(su_manv_tab,
             caption = "Summary statistics for the MANOVA test on the PC scores. `Pr(>F)` is the p-value associated with the F statistic of the effect and test statistic. ")
```

<!-- statistical test of difference in shape described in previous paragraph -->

To test for differences in the distributions of shape variables indicated by the PC scores shown in Figure \@ref(fig:first-two-PCs-byplot), we used a multivariate analysis of variance (MANOVA) test to compare pairwise combinations across our three occupation phases. Table \@ref(tab:MANOVA-table) shows significant differences in shape between Pre-European and Post-European phases (p = $`r pval_post_pre`$), and Pre-European and Chinese phases (p = $`r pval_chi_pre`$). Although there is considerable overlap of shape variables between the Pre-European and Post-European phases, their PC scores are significantly different from each other. There is little difference between vessel shapes in the Post-European and Chinese contact periods. 

<!-- CV equality testing -->

To compare pottery shape standardization across the three phases we investigate the distributions of the first three PC scores, taking the PC scores as proxy variables for vessel shape (Figure \@ref(fig:PCs-distribution)). The first PC, vessel height, shows higher variation in the pre-European period compared to the Chinese period. That indicates that shape standardization was higher in the Chinese period compared to the pre-European period. The second PC also presents a similar pattern of higher shape standardization in the Chinese period compared to the other two phases. To see whether the differences in the distribution of PCs between any two phases are substantive or due to chance, we used a modified signed-likelihood ratio test to assess the equality of CVs. P-values for this significance test of CVs for PC1 and PC2 show significant differences in the standardization of vessel shapes across periods, especially between Chinese contact with either pre-European or post-European (Figure \@ref(fig:CV-test-PCs-plot), Table \@ref(tab:CV-test-PCs-table)). A significant difference is also detected between the pre-European and post-European periods.

```{r PCs-distribution, fig.cap= "The distribution of PC scores by phases"}

# function for normalized data
normalize <- function(x) (x-min(x))/(max(x)-min(x))

# for one matrix
op.p_tmp <- 
op.p$x %>% 
  as_tibble() %>% 
  mutate_all(normalize) %>% 
  as.matrix() 

row.names(op.p_tmp) <- row.names(op.p$x )

op.p$x <- op.p_tmp


# what are the variences for each PC in each period?
len <- length(op.p$x[,1])
# plot PC1-3 distribution by phase
pc_plot <- tibble(pc = c(op.p$x[,1],
                         op.p$x[,2],
                         op.p$x[,3]),
                  phase = rep(op.p$fac$phase, 3),
                  pcn = str_glue('PC{sort(rep(1:3, len))}'))

pc_plot$phase <- fct_relevel(pc_plot$phase, 
                            c("Pre-European", 
                              "Post-European"))

ggplot(pc_plot,
       aes(phase,
           pc)) +
  geom_violin() +
  ggforce::geom_sina() +
  xlab("") +
  facet_wrap(~ pcn, ncol = 1) +
  theme_minimal()
ggsave(here("analysis/figures/pcs-boxplot-for-shape-variation.png"),
       h = 10, w = 5)
```

```{r CV-test-PCs-table}
library(cvequality)
# CVs on shape PCs for standardization
pc1 <- data.frame(
x = op.p$x[,1],
y = as.character(op.p$fac$phase),
stringsAsFactors = F)

cv_test_pc1 <- mslr_test(nr = 1000, pc1$x, pc1$y)

pc2 <- data.frame(
  x  = op.p$x[,2],
  y = as.character(op.p$fac$phase),
  stringsAsFactors = F)

cv_test_pc2 <- mslr_test(nr = 1000, pc2$x, pc2$y)

pc3 <- data.frame(
  x  = op.p$x[,3],
  y = as.character(op.p$fac$phase),
  stringsAsFactors = F)

cv_test_pc3 <- mslr_test(nr = 1000, pc3$x, pc3$y)

# do this pairwise
cv_test_pc1.1 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Post-European", 
                               "Pre-European")], 
            pc1$y[pc1$y %in% c("Post-European", 
                               "Pre-European")])

cv_test_pc1.2 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Chinese", 
                               "Pre-European")], 
            pc1$y[pc1$y %in% c("Chinese", 
                               "Pre-European")])

cv_test_pc1.3 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Chinese", 
                               "Post-European")], 
            pc1$y[pc1$y %in% c("Chinese", 
                               "Post-European")])

PC1_cv_tests <- 
bind_rows(cv_test_pc1.1, cv_test_pc1.2, cv_test_pc1.3) %>% 
  bind_cols(phases = c("Post-European vs Pre-European",
              "Chinese Contact vs Pre-European",
              "Chinese Contact vs Post-European"))

cv_test_pc2.1 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Post-European", 
                               "Pre-European")], 
            pc2$y[pc2$y %in% c("Post-European", 
                               "Pre-European")])

cv_test_pc2.2 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Chinese", 
                               "Pre-European")], 
            pc2$y[pc2$y %in% c("Chinese", 
                               "Pre-European")])

cv_test_pc2.3 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Chinese", 
                               "Post-European")], 
            pc2$y[pc2$y %in% c("Chinese", 
                               "Post-European")])

PC2_cv_tests <- 
  bind_rows(cv_test_pc2.1, 
            cv_test_pc2.2, 
            cv_test_pc2.3) %>% 
  bind_cols(phases = c("Post-European vs Pre-European",
                       "Chinese Contact vs Pre-European",
                       "Chinese Contact vs Post-European"))

PC1_PC2_cv_tests <-
bind_rows(PC1_cv_tests, 
          PC2_cv_tests, .id = "PC") %>% 
  mutate(PC = str_glue('PC{PC}')) %>% 
  mutate(PC = as.character(PC)) %>% 
  mutate_at(c("MSLRT", "p_value"), round, 4)

knitr::kable(PC1_PC2_cv_tests,
             caption = "P-values of the CV equality test of PC1 and PC2 between phases")
```

# Discussion

Previous investigations at Kiwulan have suggested an unequal distribution of prestige goods, trade ornaments specifically, following the appearance of Europeans [@Cheng2008; @Wang2011], hinting at the emergence of social inequality in the Indigenous community. Here we have examined ceramic vessel shape standardization to measure craft specialization as a proxy for social differentiation, such as elite control [@Costin2001; @Junker1999]. Our results indicate that differences in pottery shape can be detected using EFA. The result of our MANOVA test shows there is a significant difference in shapes between the pre-European and Post-European periods, and between the pre-European and the Chinese periods. The average shape presents a round body with a wider rim and neck before European contact, and turns to a more oval-shaped body with narrower rim and neck after the European presence. These changes even more pronounced during the Chinese contact period. In general, pottery vessels become shorter in height over time, leading to an oval-shaped body. 

Our CV tests indicate that there are significant differences in shape standardization between the pre-European period and post-European period, and between the Chinese contact and either pre-European or post-European periods. This suggests pottery shape became more homogeneous and standardized after foreign contacts with European colonizers and even more so after contact with Chinese immigrants. Compositional analysis shows that the clay pastes are similar, regardless of the increasing standardization of the pottery shape, reflecting continuity in the raw material sources. We can thus rule out changes in clay fabric as a factor in explaining changes in vessel shape. To determine if shape changes might be related to changes in the function of pots at Kiwulan, we used geochemical methods to extract and identify lipids trapped in the fabric of potsherds to identify foods that may have contributed residues absorbed into the clay [cf. @Kwak2015]. Unfortunately, we did not obtain useful results due to extremely low lipid yields, which is probably due to the very thin, dense, and low porosity fabric of Kiwulan pottery. These physical characteristics of the clay offer limited spaces to trap and protect organic molecules from microbiological degradation [cf. @Evershed2008, pp. 909].

We compare the result of shape variable with the result of metric data for six measurements and two ratio values using CV test (Table \@ref(tab:metricCVstest)). Metric measurements show there is a significant difference (p-value less than 0.01) between CV values for two metric measurements across phases, the rim diameter and the neck diameter before and after the European presence. After the arrival of the Chinese, there is only one metric attribute, the rim diameter, showing significant difference compared with post-European period (p-value less than 0.05). Although these results show the differences between different contact phases that corresponds to part of the results of shape variable, elliptic Fourier analysis captures more subtle differences in a substantial way reflected by overall shapes of pottery, not only limited to diameter variables. In addition, the result of spatial analysis (Figure \@ref(fig:kernel-plot)) for pottery shape samples presents multiple clusters with high density of pottery during the European presence. However, the hypothesis testing on spatial randomness indicates a non-randomly dispersed distribution before European contact and more extreme dispersed after European presence. In contrast, the distribution of pottery is more similar to the random distributions during the Chinese period. This contradicts our expectation that clustered pattern will be observed with an increase in pottery standardization since the emergence of specialized groups. Or, this may indicate that there are other factors lead to pottery shape standardization instead of a small number of artisans. 

```{r metricCVstest}

# select metric attributes and tidy data for computing CV
kwl_p_metrics_long <-
  kwl_p_ave %>%
  mutate(dia_rim_body = Dia_Rim_ave/Dia_Body_ave,
         thi_rim_body = Thick_Rim_ave/Thick_Body_ave) %>%
  select(period, 
         Dia_Rim_ave, Dia_Neck_ave, 
         Dia_Body_ave, Thick_Rim_ave, 
         Thick_Neck_ave, Thick_Body_ave,
         dia_rim_body, thi_rim_body,) %>%
  rename(`Rim diameter (mm)` = Dia_Rim_ave,
         `Neck diameter (mm)` = Dia_Neck_ave,
         `Body diameter (mm)` = Dia_Body_ave,
         `Rim thickness (mm)` = Thick_Rim_ave,
         `Neck thickness (mm)` = Thick_Neck_ave,
         `Body thickness (mm)` = Thick_Body_ave,
         `Ratio of Rim/Body diameter` = dia_rim_body,
         `Ratio of Rim/Body thickness` = thi_rim_body) %>%
  gather(variable, value, -period) %>%
  filter(!is.na(period), !is.na(value)) %>% 
  mutate(variable = factor(variable, levels = c("Rim thickness (mm)",
                                                "Neck thickness (mm)",
                                                "Body thickness (mm)",
                                                "Ratio of Rim/Body thickness",
                                                "Rim diameter (mm)",
                                                "Neck diameter (mm)",
                                                "Body diameter (mm)",
                                                "Ratio of Rim/Body diameter"))) %>%
  arrange(variable)

# filter pre-e and post-e periods
kwl_p_metrics_long_pre_post <-
  kwl_p_metrics_long %>%
  filter(!period == "ch-con")
# filter post-e and chi periods
kwl_p_metrics_long_post_chi <-
  kwl_p_metrics_long %>%
  filter(!period == "pre-e")

#---------------------------CV test for pre-e and post-e pair
kiwulan_pottery_metrics_cvs_plot_cv_test_asym_pre_post <-
  kwl_p_metrics_long_pre_post %>%
  nest(-variable) %>%  # or nest(period, value) %>%
  mutate(asymptotic_test = map(data, # change from mslr_test to asymptotic_test
                               ~bind_cols(asymptotic_test (
                                 .x$value,
                                 .x$period)))) %>%
  unnest(asymptotic_test)
# compute CV
kwl_p_cvs_pre_post <-
  kwl_p_metrics_long_pre_post %>%
  group_by(period, variable) %>%
  summarise(cvs = raster::cv(value, na.rm = TRUE))
# join p-values to CVs
kwl_p_cvs_and_pvalues_pre_post <-
  kwl_p_cvs_pre_post %>%
  left_join(kiwulan_pottery_metrics_cvs_plot_cv_test_asym_pre_post) %>%
  mutate(significant = ifelse(p_value <= 0.05, 'yes', 'no')) %>%
  mutate(variable = factor(variable, ordered = TRUE)) %>%
  arrange(variable)
# making table for CV
kwl_p_cvs_table_pre_post <-
  kwl_p_cvs_and_pvalues_pre_post %>%
  select(-data, -significant) %>%
  pivot_wider(names_from = period, values_from = cvs) %>%
  select(variable, `pre-e`, `post-e`, `D_AD`, `p_value`) %>%
  mutate_at(c("pre-e", "post-e", "D_AD", "p_value"), round, 4)

#---------------------------CV test for post-e and ch-con pair
kiwulan_pottery_metrics_cvs_plot_cv_test_asym_post_chi <-
  kwl_p_metrics_long_post_chi %>%
  nest(-variable) %>%  # or nest(period, value) %>%
  mutate(asymptotic_test = map(data, # change from mslr_test to asymptotic_test
                               ~bind_cols(asymptotic_test (
                                 .x$value,
                                 .x$period)))) %>%
  unnest(asymptotic_test)
# compute CV
kwl_p_cvs_pre_post <-
  kwl_p_metrics_long_post_chi %>%
  group_by(period, variable) %>%
  summarise(cvs = raster::cv(value, na.rm = TRUE))
# join p-values to CVs
kwl_p_cvs_and_pvalues_post_chi <-
  kwl_p_cvs_pre_post %>%
  left_join(kiwulan_pottery_metrics_cvs_plot_cv_test_asym_post_chi) %>%
  mutate(significant = ifelse(p_value <= 0.05, 'yes', 'no')) %>%
  mutate(variable = factor(variable, ordered = TRUE)) %>%
  arrange(variable)
# making table for CV
kwl_p_cvs_table_post_chi <-
  kwl_p_cvs_and_pvalues_post_chi %>%
  select(-data, -significant) %>%
  pivot_wider(names_from = period, values_from = cvs) %>%
  select(variable, `post-e`, `ch-con`, `D_AD`, `p_value`) %>%
  mutate_at(c("post-e", "ch-con", "D_AD", "p_value"), round, 4)

# join two table together
kwl_p_cvs_table_all <-
  kwl_p_cvs_table_pre_post %>% 
  left_join(kwl_p_cvs_table_post_chi, "variable") %>% 
  select(-`post-e.y`) %>% 
  rename(`before European` = "pre-e", `European` = "post-e.x", Chinese = "ch-con",
         `D_AD-1` = "D_AD.x", `D_AD-2` = "D_AD.y",
         `P value-1` = `p_value.x`, `P value-2` = `p_value.y`) %>% 
  select(variable, `before European`, European, Chinese,
         `D_AD-1`, `P value-1`, `D_AD-2`, `P value-2`)

knitr::kable(kwl_p_cvs_table_all,
             caption = "Coefficient of Variation for metric attributes by three phases using Asymptotic test [@Feltz1996]. The first set of P-value represents the comparison between before European and European periods, while the second represents the comparison between European and Chinese periods ")
```

```{r kernel-plot, fig.cap= "Kernel density map visulizes the probability of the density of pottery across space. The map shows  major core area during the pre-European period, multiple core areas during the European period, and a single core during the Chinese period. Used the bandwidth based on Silverman (1986)'s rule of thumb"}
knitr::include_graphics(here("analysis", "figures", "plot-kde-maps.jpg"))
```

```{r Monte-Carlo-spatial-pattern, fig.cap= "Histograms of simulated average nearest-neighbour distances (ANN) values from 1000 simulations for three phases. X-axis values based on meteres represent ANN expected value. Each sample distribution presents the null hypothesis with the blue line indicating the observed ANN value"}
knitr::include_graphics(here("analysis", "figures", "plot-kde-ann-histograms.jpg"))
```

Our results offer tentative support for the hypothesis that foreign influences at Kiwulan influenced emergence of social inequality in the local Indigenous society. If increased shape standardization is a reliable indicator of craft specialization, then we may be seeing evidence of a shift from corporate to network organization [@Feinman2000]. However, strong claims for an emergence of social complexity resulting from foreign contact at Kiwulan will need support from multiple and diverse sources of evidence. This should include the other two main datasets at Kiwulan, the ornaments assemblages, and the burial goods. We find vessel shapes were more standardized in the Chinese period than the European period, contrary to previous work that has downplayed the effect of Chinese settlement in Yilan [@Wang2011]. Compared to other regions in Taiwan, European colonial influence was weak in Yilan due to the isolated of the surrounding mountains and the economic focus of the Spanish and  Dutch who preferred northern Taiwan as their trading base. Indigenous communities Yilan experienced indirect influence from European trade networks and their colonial activities in a pericolonial context [cf. @Acabado2017]. In contrast to the Indigenous-European interactions at Kiwulan, the interaction between Indigenous people and Chinese in the 19th century appears to have been more intense and direct. Historical records indicate that Chinese immigrants settled in Yilan and lived closely with Kiwulan Indigenous societies [@Chen1963; @Ke1993]. This direct influence is reflected by the archaeological evidence of large amounts of Chinese porcelains and distinctive architectural bricks and tiles used by Chinese [@Hsieh2009]. Similarly, burials at Kiwulan in this later phase show the adoption of coffins in mortuary practices, which @Chen2007 interprets as the adoption of a symbol of ethnic Chinese. 

We recognize that the shape variation reported here is subtle, and this invites consideration of the possibility that the absence of major changes in vessel shape at Kiwulan may have been an act of resistance to foreign influence. Continuities in vessel shape over time draws our attention to the endurance of traditional pottery production practices amid intrusions from Europeans and Chinese. In a culture contact situation, social identity may be expressed through material practices to show cultural homogeneity and distinction from other groups [@Voss2005]. It is also important to recognize that social identity might be more complicated in a colonial context, and may be more than a colonized–colonizer or local/foreign dichotomy [@Voss2005; @Voss2008]. Shamaoshan cemetery (3BC- 4AD) in Southwest China shows that the process of the incorporation of Southwest China into the Han Empire involved a century of conflicts, resistance, and acceptance among social groups with different identities, especially in the historical context of Han immigrants [@Wu2019]. A similar dynamic may have occurred at Kiwulan, with vessel shape indicating both acceptance of foreign influence through increased shape standardization, and resistance through the overall continuity in vessel shape. Vessel shape can be viewed as a symbol as an expression the Indigenous identity and social boundaries because shape is a highly visible trait compared with other features of pottery [cf. @Roux2015]. Although there is an increase in number of imported ceramics over time at Kiwulan, the production of the local pottery continued and became more standardized. This might imply not only a utilitarian function of the local vessels, but a deliberate action to emphasize the local pottery tradition as their cultural custom as foreign contact intensified. 

# Conclusion

This study demonstrates an application of elliptic Fourier analysis on ceramic shapes to explore the emergence of ceramic specialization as indicative of foreign influences. Here, EFA is combined with a significance test for the equality of CVs of shape variables to provide a robust way to identify and statistically assess differences in shape standardization. The direct relationship between foreign influences and standardization of ceramic shape was tested on pottery from Kiwulan, and large Iron Age Indigenous settlement in northeastern Taiwan. Lower variation in ceramic shape was identified after European presence began, and even lower variation during the period of Chinese presence. Our findings help to understand the factors that may lead to standardization of pottery production in a cross-cultural interaction context. More homogeneous shapes during the contact periods, without any changes in clay paste composition or production technique, suggests that shape standardization was intentional. The results here further suggest that expressions of social identity or cultural boundaries in Indigenous societies through highly visible vessel qualities, such as shape, may be heightened during periods of foreign intrusion in pericolonial contexts. Our analysis, with its openly available methods and data, is readily extensible to other pottery assemblages in the region to further explore related questions about craft specialization and standardization in Iron Age ceramic technologies.

# Acknowledgements

We would like to thank the Yilan County Cultural Affairs Bureau in Taiwan for permitting access to the pottery used in this study and providing the shape images. We thank Dr. Wen-Shan Chen in the Department of Geosciences, National Taiwan University for his invaluable guidance of petrographic analysis at his lab. We thank the Quaternary Research Center funding for supporting the organic residue analysis in this project. We thank Dr. Julian Sachs in the Department of Oceanography, University of Washington for his supports and providing his lab for us to conduct organic geochemistry analysis of potsherds. We thank Dr. Matthew Wolhowe for his help in developing protocols for lipid extraction and his assistance with the GC-MS, GC-FID, and GC-C-IRMS analyses. This research used statistical consulting resources provided by the Center for Statistics and the Social Sciences, University of Washington. 

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```

Word count: `r wordcountaddin::word_count()`
