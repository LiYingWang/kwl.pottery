---
title: "Investigating social change during cultural contact period using geometric morphometry of pottery shapes from Iron Age northeastern Taiwan"
author:
  - Li-Ying Wang
  - Ben Marwick
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  dpi = 300,
  fig.path = "../figures/"
)
```

# Introduction

Ceramic production can reflect prehistoric socioeconomic patterns since it relates to not only economic base for households but also societies as a whole when specialized production was organized. Identifying the specialization in ceramic production will help to understand how complex societies form and further explore the underlying mechanism. One way to examine ceramic specialization is to identify whether ceramics present standardization in production, which based on the assumption that the specialized mass production will lead to uniformity of the product due to increased skills, routinization, and lower diversity of producers that enable us to interpret social organization or social relations such as type of production, and the presence of elite control [@Arnold2000, pp. 334; @Stark1995; @Costin1991]. 

Several variables have been proposed to measure ceramic standardization, including metric, compositional, and technological attributes [@Rice1991; @Blackman1993; @Costin1991; @Hirshman2010; @Tite1999]. However, traditional typological and linear measurements are limited because they can be insensitive to subtle variations resulting from changes in craft specialization. Taking a new approach to the measurement of craft specialization, we studied shape and standardization of locally made pottery to identify changes in pottery production at Kiwulan (1400-1900 AD), a large multi-component archaeological site in northeastern Taiwan. We apply geometric morphometric methods to study artifact shapes to investigate if there are any changes resulting from foreign contact of European and Chinese that might indicate social changes in the indigenous society. 

Culture contact between indigenous people and colonizer with imperial power usually leads to profound changes in local indigenous societies. We explore the culture changes in indigenous societies in northeastern Taiwan that experienced foreign contacts with the Europeans and Chinese since 17th century by examining the local pottery production. We observed pottery production in northeastern Taiwan in the late Iron Age period and historical period (1400-1900 AD) presenting a high consistency in form and shape compared to other pottery found from other regions on this island that hints the emergence of pottery specialization. Our aim is to explore the impact of foreign contacts on local indigenous societies in northeastern Taiwan by examining pottery production as an indicator for social changes. Using pottery shape as a proxy to study craft specialization, we answer these questions: Did foreign contacts have impacts on indigenous pottery production that can be detected in the shape of the vessels? How does pottery change in shape throughout 600 years at this site? Did pottery become more homogeneous and standardized in shape after foreign contacts with the European colonizer or the Chinese immigrant? 

Our hypothesis is that if foreign contacts including European and Chinese had impact on the emergence of social inequality in local indigenous society due to the monopolies for trade between a small number of indigenous people, then we expect to see the changes in social organization from a more corporate to a more network organization that would be reflected by pottery production at Kiwulan. The emergence of craft specialization, here pottery specialization, are usually related to the presence of elite control. In this case, if the competitions for foreign resources and being trade partners of European or Chinese colonizer among individuals gradually lead to the emergence of social inequality, then I expect the local pottery will show more homogeneous features after contact due to the craft specialization caused by control of small group of individuals. The first step is to detecting pottery standardization when discussing the emergence of craft specialization and the possible changes in social organization. This paper uses Elliptic Fourier Analysis, one outline approach in Geometric morphometric methods, to test whether there was increasing pottery standardization in relation to foreign contacts. 

# Geometric Morphometric approach: shape analysis for pottery specialization

Geometric morphometric methods (GMM) has been widely applied recently in archaeology for shape analysis, which explores morphological variability and similarity of archaeological materials to address the questions of anthropological interests. Different from linear measurement approaches that capture shapes by measuring length, width or ratios of objects, geometric morphometrics methods use Cartesian coordinates of morphological structures to define the shapes [@Adams2004; @Bookstein1997; @Lawing2010; @Slice2007]. Landmarks, curves or outlines of objects can be represented by coordinates by their unique point location with respect to numerical values of coordinate axes. According to different focuses and nature of original shape data, there are two common morphometric methods used to capture and analyse the shapes, landmark approaches and outline approaches [@Adams2004]. Landmark approaches assign a set of landmarks or semilandmarks onto objects as reference points that can be specified on a coordinate system as x, y coordinates for two dimensions, or x, y, z coordinates for three dimensions. Based on distances between raw landmarks, objects are translated to a common centroid, rescaled into the same size, and rotated until the summed squared distances between corresponding landmarks are minimized using generalized Procrustes analysis (GPA) [@Bookstein1991]. GPA is a method that superimposes sets of landmark configurations into a common coordinate system, where superimposed landmark coordinates are used as shape variables for further multivariate statistics analyses[@Slice2007]. Landmark-based morphometrics are widely used for archaeological objects where morphological signature is obvious to identity which provides ideal reference points for landmark placement, such as projectile point tips or biologically measurements points indicating osteological features [@Birch2019; @Buchanan2019; @Lycett2013; @Cardillo2010; @Haruda2019; @Meloro2015]. 

However, one limitation of landmark-based morphometrics is that landmark data may not be able to capture the shape differences of a morphological structure where the curving outlines between landmarks convey important information. In addition, obvious and reliable landmark points may be unavailable for complex or rounded shaped structures. In those cases, outline approaches serve as a solution by analyzing the overall shape of a morphological structure. One of the outline approaches is semi-landmarks method, also called sliding landmarks, which assigns points along the curve between two landmarks at defined intervals [@Bookstein1997; @Lawing2010]. Those semi-landmarks are allowed to slide along the curve to remove the effect of the arbitrary landmark spacing by minimizing either Procrustes distance or bending energy [@Bookstein1997; @Slice2007; @Gunz2013]. Another approach is elliptic Fourier Analysis (EFA) commonly used for two-dimensional closed shape which turns coordinates into coefficients [@Kuhl1982]. EFA uses periodic functions to capture geometric information, where an outline is decomposed into a series of ellipses described by trigonometric functions, called harmonic coefficients [@Adams2004; @Claude2008; @Bonhomme2014]. The number of harmonics determines the quality and precision of the geometry of an object. The harmonic power, a cumulated sum of squared harmonic coefficient, provides a robust rule for desired number of harmonics [@Bonhomme2014]. The application of EFA in archaeology is mostly used for bone morphology to understand the biological variation and recently more for stone artefacts to explore stone tool technology [@Fox2015; @Hoggard2019; @Iovictua2010]. Outline approach based on EFA is suitable for shapes lacking obvious landmarks or curves convey more important information indicating the meaningful variations, for example, ceramics. @Wilczek2014 evaluate the concordance between outline-based approaches, the EFA and the Discrete Cosine Transform (DCT), and traditional typology by studying 154 complete ceramic vessels with varied shapes from the Bibracte oppidum in France. They found that the variation in ceramic shapes analysed by EFA and DCT matches traditional ceramic typology, which supports that outline-based approaches can be efficiently used for studying variations in ceramic shapes. In addition, the results of shape variation by EFA helps to understand the level of production standardisation over time across that region. 

In this paper, we use EFA for pottery shape analysis to evaluate the level of standardization of pottery from an Iron Age site in northeastern Taiwan in relation to the European presence in the 17th century that might hint the emergence of craft specialization for pottery production. Craft specialization can provide further evidence about the type of production organization which is closely related to economic or political aspects of society [@Arnold2000; @Blackman1993; @Costin1991; @Hirshman2010; @Stark1995]. The emergence of craft specialization can also be an indicator of social inequality that hints the possibility of the presence of production groups worked for specific individuals. The presence of craft specialization is commonly studied by measuring the standardization of ceramics based on the assumption that the specialized mass production will lead to uniformity or homogeneity of the product due to increased skills, routinization, and lower diversity of producers [@Arnold2000]. To test the prediction of a shift in the level of social inequality in this case study in northeastern Taiwan influenced by the colonial European presence, we use standardization of pottery in shapes as an index for craft specialization to identify the presence of a few individuals controlling large scale pottery production [@Costin1995; @Hirshman2010] using outline-based geometric morphometrics couples with traditional metric measurements to compare and evaluate the use of outline approaches for pottery with high consistency in shapes. 

- CV is hard to test, we apply some statistics testing for it

# Materials and methods

## Archaeological pottery from Kiwulan 

Pottery analysed in this paper comes from Kiwulan, northeastern Taiwan. Kiwulan is situated on a hill near a riverside at the northern margin of Yilan, which is characterized by a triangular alluvial plain facing eastwards the Pacific and mountains on three other sides. Kiwulan dates to AD 1350 to AD 1950, which covers around 600 years from the late Iron Age to the historical period started with the European presence in Taiwan in the early 17th century. The Dutch first came and occupied southern Taiwan in 1624 and then the Spanish occupied northern Taiwan in 1626. In 1642, the Spanish was expelled by the Dutch, who took over their forts in northern Taiwan. Since then, western Taiwan was mostly under the colonial rule of the Dutch until 1662 when the Kingdom of Tungning was founded by Koxinga, a loyalist of Ming dynasty of China. 

The upper component experienced frequent foreign contacts including the European colonial presence in the 17th century and great waves of Chinese immigrants since 19th century. The excavation revealed abundant artifacts in which potsherds are the dominate materials throughout the site. Imported ceramics from mainland China, stonewares, and ornament elements such as beads were also commonly found in the upper component that indicates the frequent long-distance trade activities in the 17th century during the European presence. In addition to artifacts, features were also found, such as burials, middens, and post-holes with in-situ posts that explains Kiwulan was a large settlement site. 

Pottery found at Kiwulan are all locally made. 
Most sherds are fired to an orange to brownish color with a fully oxidized core or a reduced core with oxidized fringes. It seems that there is no significant relationship between color and phases. Petrographic analysis for thin sections was conducted at the Department of Geosciences, National Taiwan University. The results shows high percentage of inclusions (15-50%), including argillite, quartz, feldspar, metasandstone, sandstone fragment, and slate. Those minerals are believed to be local materials of the Yilan Plain. The most common type of sherds, also the dominant one, has a high percentage of inclusion (25-40%), which is composed mainly by argillite (15-40%), followed by metasandstone (1-10%), sandstone (1-6%), and quartz (1-5%). The size of the particles ranges from 500 micron to 1300 micron (=1 mm). Overall, this type presents a mixture of fine, rounded argillite with a small part of rounded metasandstone and rounded to sub-angular monocrystalline quartz.  

```{r tidy-data}
# Once we have the jpgs, start from here
library(tidyverse)
library(here)

# get list of jpgs only
jpgs <- list.files(here("analysis/data/raw_data/outline_jpg"), pattern = ".jpg", full.names = TRUE)

# join file names to phase
pottery_data <- readr::read_csv(here("analysis/data/raw_data/KWL_Ceramic_final2018_with_phases.csv"))
pottery_data <- pottery_data %>% 
  mutate(filename = str_glue('fill_{filename}.svg_output.jpg'))

# some outlines that we have no phases for... 
sdiff <- setdiff(pottery_data$filename, basename(jpgs))

# the ones we do have both outlines and phases
isect <- intersect(pottery_data$filename, basename(jpgs))

jpgs <- jpgs[basename(jpgs) %in% isect]
pottery_data <- 
  pottery_data %>% 
  filter(filename %in% isect) %>% 
  distinct(filename, phase, .keep_all = TRUE)

phases_isect <- 
  pottery_data %>%  
  select(filename, phase) %>% 
  filter(filename %in% isect) %>% 
  mutate_all(as.factor) %>% 
  distinct(filename, phase) %>% 
  mutate(phase = as.factor(case_when(
    phase == 'post-e' ~ "Post-European", # include European period and after it before Chinese contact
    phase == 'pre-e' ~ "Pre-European",
    phase == 'ch-con' ~ "Chinese" # we can combine Chinese and post-Euro
  ))) 

# how many pots in each phase?
phase_fre <- phases_isect %>% 
  group_by(phase) %>% 
  tally(sort = T)

total_no <- sum(phase_fre$n)
```

A total of `r total_no` vessels from pre-contact contexts (n = 32), post-European contexts (n = 27), and Chinese contact contexts (n = 14) were selected for this study because of their completeness mostly covering parts from rim to bottom. The scanned pottery drawings of those pots were acquired from Bureau of Cultural Affairs in Yilan. All drawing presents two-dimensional view of the section of a vessel with indications of metric measurements. The scanned drawings were imported into the Inkscape software for outlines tracing to remove additional information such as marks, lines, and measurements on the original drawings. Each traced half cross-section image was duplicated, flipped, and then joined with another one to create a 2D closed outline.

## Metric measurements

In this study, we examine 291 pots recovered from Kiwulan site. The layer from 1 to 6 could be divided into 3 time periods. Layer 5 and 6 represent pre-contact period, layer 4 represents contact period, and layer1, 2, and 3 represent post-contact period.  The amount of pots for each layer shows below. Although most pots are not complete, the thickness from rim, neck, to body can be measured. I have also measured the diameter of rim, neck, and body. For those pots that are incomplete, the diameter is measured by its curvature. Since the height is incomplete for most pots, this preliminary analysis focuses more on the possible change in thickness and diameter of pot for different parts, and their ratio over time.

## Outline analysis

Geometric morphometric analyses were conducted in the R software (www.rproject.org, Core-Team, 2015) using the functions included in the Momocs, a R package intended to quantify the shape and compare its variation, especially for outline analysis [@Bonhomme2014]. The digitised outlines were converted into a list of successsive x-y pixel coordinates for elliptic Fourier analysis (EFA), which assesses morphological differences among pottery shapes from three occupation contexts. 

The harmonic coefficients generated by EFA were analysed by principal component analysis (PCA) to illustrate the diversity of the shape data and identify the major patterns of variation through dimensionality reduction. The principal components (PCs) scores were analysed with a multivariate analysis of variance (MANOVA) to test for significant effects of the groups of occupation context on shape variances. Finally, we computed coefficients of variation statistic (CVs) among multiple groups of PCs with a significance test for the equality of CVs, which enable us to compare CVs in a statistical way (Karl Pearson 1896). The coefficient of variation is a common and widely-used statistical measure of the spread of a set of measurements of a sample. It is defined as the standard deviation divided by the mean in a ratio scale format.

$$c_v = \frac{\sigma}{\mu}$$

By standardizing standard deviation in each data set, the coefficients of variation statistics allows us to directly compare variation in samples measured with different units or means. Although it is a useful method, there is a question that how should we make a decision that the differences among the multiple CVs are significant or not? To answer this question, we need convenient methods for testing the equality of $c_v$ values from different samples, which has been described in many publications and here we proposed a significant test for CVs using the R package cvequality [@Marwick2019] in the CRAN repository. The package cvequality includes two tests, the "Asymptotic test for the equality of coefficients of variation from k populations" (Feltz and Miller 1996) and the "Modified signed-likelihood ratio test (SLRT) for equality of CVs" (Krishnamoorthy and Lee 2014). Feltz and Miller (1996) test is widely cited as an authoritative test for the equality of $c_v$ values that performs better than many approximative tests. It is a 'gold standard' test for comparing multiple $c_v$. Our implementation is based on the following from Feltz and Miller (1996):

Let $s_i$ be the observed standard deviation of the $i$th sample (or group of measurements), $x_i$ be the observed mean of the $i$th sample, and let 

$$m_i=n_i-1$$

and we do not know the population $c_v$, so let $\widehat{\tau }_c$ be an estimate as follows:

$$\widehat{\tau }_c = \frac{\left( \sum _{j=1}^km_j\frac{S_j}{\bar{x}_j} \right)}{M}$$ 
where 
$$M=\sum _{j=1}^m m_j$$ 
Then the test statistic can be computed with: 
$$\begin{aligned} D'A D= \widehat{\tau }_c^{-2}\left( 0.5+\widehat{\tau }_c^2\right) ^{-1}\left[ \sum _{i=1}^km_i\left(\frac{s_i}{\bar{x}_i} \right)^2-\frac{\widehat{\tau }_c^2}{M} \right] \end{aligned}$$
The $D'AD$ value measures how far each sample $c_v$ is from our estimate of the population $c_v$. Feltz and Miller (1996) note that the $D'AD$ value distributes as a central $\chi^2$ random variable with $k-1$ degrees of freedom, from which a p-value can be computed. 

We also include the Krishnamoorthy and Lee (2014) test as a more recent development with lower rates of type I error, better performance with uneven sample numbers, and more power across a range of conditions. 

# Reproducibility and open source materials 

To enable re-use of materials and improve reproducibility and transparency [@Marwick2017], the entire R code [@Rlanguage2019] used for all the analysis and visualizations contained in this paper is included in http:XXX. Also in this version-controlled compendium [@Marwick2018] are the raw data for all the visualizations and tests reported here. All of the figures, tables, and statistical test results presented here can be independently reproduced with the code and data in this repository. The code is released under the MIT license, the data as CC-0, and figures as CC-BY, to enable maximum re-use. 

# Results

```{r jpg-coordinates, eval=FALSE}
# start shape exploration
library(Momocs)
#  it freezes on the empty ones...
jpgs_imported <- import_jpg(jpgs, threshold = 0.5)

# Normalise the shapes, from 
# https://www.repository.cam.ac.uk/bitstream/handle/1810/266423/Supplementary%20Code%20S1.pdf?sequence=20&isAllowed=y
jpgs_imported_coo <- 
  jpgs_imported %>% 
   Out(., fac = phases_isect)  %>% 
  # Centring, scaling and sampling pseudo-landmarks
   coo_center %>% 
   coo_scale %>% 
   coo_sample(., 1000) %>% 
  # Procrustes superimposition for pseudo-landmarks
   fgProcrustes %>% 
  # Normalisation of the starting points
   coo_slidedirection

saveRDS(jpgs_imported_coo,
        here::here("analysis/data/derived_data/jpgs_imported_coo.rds"))
```

The elliptic Fourier coefficients of `r total_no` pottery from three phases were calculated. Reliable pottery outline was captured by 13 harmonics that gather 99 % of the total harmonic power. The mean pottery shape of each phase was visualized by calculating the mean of the standardized Fourier coefficients within each group. 
Thin-plate splines compares the average shapes of vessels from each period to visualize the outline deformations required to pass from an extreme of one morphospace to the other. 

```{r EFA-analysis}
library(Momocs)
library(cowplot)
jpgs_imported_coo <- readr::read_rds(here::here("analysis/data/derived_data/jpgs_imported_coo.rds"))

# default is 13 harmanics that gather 99% of the harmonic power 
op <- efourier(jpgs_imported_coo, norm = FALSE, 13)

# mean shape, per group
pot.ms <- MSHAPES(op, 'phase')
mshp <- pot.ms$shp
names(mshp) <- c("chi", "poe", "pre") 

`Post-European` <- mshp$poe %T>%  coo_plot( border="blue")
`Pre-European` <-  mshp$pre  %T>% coo_plot(border="red", plot.new=FALSE)
`Chinese` <-       mshp$chi  %T>% coo_plot(border="green", plot.new=FALSE)
legend("topright", 
       lwd=1,
       col=c("red", "blue", "green"), 
       legend=c( "Pre-European", "Post-European", "Chinese"))

# Thin plate spline analysis (TPS)
# Thin plate splines (TPS) was used to compare average shapes and visualise the outline deformations required to pass from an extreme of the morphospace to the other.
# Deformation grids

tps_grid(`Pre-European`, `Post-European`, shp.lwd = c(2, 2), shp.border = c("red", "blue"),
         amp = 1, grid.size = 18, legend = T)
dev.off()

tps_grid(`Pre-European`, `Chinese`, shp.lwd = c(2, 2), shp.border = c("red", "blue"),
         amp = 1, grid.size = 18, legend = T)
dev.off()

# Isodeformation lines
png(here::here("analysis/figures/tps-iso.png"), res = 600, w = 1200, h = 1800)
de_pre_post_plot <- 
  tps_iso(`Pre-European`, `Post-European`,  shp.lwd = c(2, 2), shp.border = c("red", "blue"),
          amp = 0.5, iso.nb = 10000, iso.levels = 12, legend.text = c("Pre-contact", "Post-contact"),
          palette = col_summer, grid = F)
dev.off()

de_pre_chi_plot <- 
  tps_iso(`Pre-European`, `Chinese`,  shp.lwd = c(2, 2), shp.border = c("red", "blue"),
          amp = 0.5, iso.nb = 10000, iso.levels = 12, legend.text = c("Pre-contact", "Chinese"),
          palette = col_summer, grid = F)
dev.off()

# Doesn't work if the plot is not produced by ggplot?
# plot_two_de_by_period <- 
  #plot_grid(de_pre_post_plot, de_pre_chi_plot, labels = c('A', 'B'))

#knitr::include_graphics(here::here("analysis", "figures", "tps-pre-Euro-to-post-Euro.png"))
#knitr::include_graphics(here::here("analysis", "figures", "tps-pre-Euro-to-Chinese.png"))

```

```{r PCA-analysis}
# these are fast
op.p <- PCA(op)
# proportion of variances explained, PC1 and PC2 explain 79% of variation
pro_vari <-scree_plot(op.p)$data
vari_two <- round(pro_vari$cumsum[2],4)*100
vari_three <- round(pro_vari$cumsum[3],4)*100

# the pots groups by phase, and their shape distribution according to 
# the first two principle components of the EFA 
png(here::here("analysis/figures/pca-biplot.png"), res = 300, w = 1500, h = 1500)
plot(op.p, 2, 
     morpho = TRUE, 
     ellipses = TRUE,
     cex = 1, 
     cex.labelsgroups = 1.5)

dev.off()

# different visualization 
plot(PCA(op), 2, pos.shp="full")
plot(PCA(op), 2, pos.shp="range")
plot(PCA(op), 2, pos.shp="xy")
plot(PCA(op), 2, pos.shp="range_axes")

plot(PCA(op), 2, pos.shp="full_axes")

# the contributions of each PC to the shapes
pc_contrib <- PCcontrib(op.p, nax = 1:3) 
pc_contrib$gg +  
  geom_polygon(fill="slategrey", col="black") + 
  ggtitle("Shape variation along PC axes") +
  theme_minimal(base_size = 6)
  
ggsave(here::here("analysis/figures/pca-contrib.png"))

# PC1 is height of vessel
# PC2 is neck constriction
# PC3 is height of neck and roundness of body
```

Outlines generated by EFA are examined by principal components analysis to explore the shape variations across three phases. The first two principal components (PCs) explain `r vari_two`% of variances, and the first three principal components (PCs) explain `r vari_three`% of variances. The PC1 relate to the height of the vessels from short to high, the PC2 reflects the neck and mouth constriction from wide to narrow, and the PC3 relates to the degree of flare of neck from curved to straight shape. The biplot of PCs presents the grouping by each occupation phase. 

```{r MANOVA}
# MANOVA: Multivariate Analysis of (co)variace
# We can test for a difference in the distribution of PC scores by calculating a pairwise combination between every levels of a fac. 

manv <-   MANOVA_PW(op.p, "phase")
manv$summary

#----------------------------------------------------
# GAMMS from https://www-nature-com.offcampus.lib.washington.edu/articles/s41598-018-20122-9

# Generalised additive mixed models (GAMMs) were used to explain shape variance with respect to mean environmental parameters and shell size, and to compare between individual shape features (PCs). A GAMM is a generalised linear mixed model with a linear predictor involving a sum of smooth functions of covariates. The model allowed for flexible specification of the dependence of the response on the covariates by defining regression splines (smoothing functions) and estimating their optimal degree of smoothness, rather than calculating parametric relationships

ggplot(pottery_data,
       aes(phase,
           as.numeric(Thick1_Neck))) +
  geom_boxplot()

pottery_data$thick_neck1 <- as.numeric(pottery_data$Thick1_Neck)
pottery_data$thick_body1 <- as.numeric(pottery_data$Thick1_Body)
pottery_data$height <- as.numeric(pottery_data$Hight)

plot(op.p$x[ , 2], pottery_data$thick_body1)

gams_input <- data.frame(thick_body1 = pottery_data$thick_body1 , 
                         height = pottery_data$height, 
                         shape_pc1 = op.p$x[ , 1])

library(brms)
m2 <- brm(bf(shape_pc1 ~ s(thick_body1)),
          data = gams_input, family = gaussian(), cores = 4, seed = 17,
          iter = 4000, warmup = 1000, thin = 10, refresh = 0,
          control = list(adapt_delta = 0.99))
summary(m2) # so many zeros... not very promising 
# plot marginal effects for each predictor
plot(marginal_effects(m2), ask = FALSE)
loo(m2)
pp_check(m2)
```

```{r CV-test}
# CVs on shape PCs for standardisation

len <- length(op.p$x[,1])
# plot PC1-3 distribution by phase
pc_plot <- tibble(pc = c(op.p$x[,1],
                             op.p$x[,2],
                             op.p$x[,3]),
                      phase = rep(op.p$fac$phase, 3),
                        pcn = str_glue('PC{sort(rep(1:3, len))}'))

pc_plot$phase <- fct_relevel(pc_plot$phase, 
                            c("Pre-European", 
                              "Post-European"))

ggplot(pc_plot,
       aes(phase,
           pc)) +
  geom_violin() +
  ggforce::geom_sina() +
  xlab("") +
  facet_wrap(~ pcn, ncol = 1) +
  theme_minimal()
ggsave(here("analysis/figures/pcs-boxplot-for-shape-variation.png"),
       h = 10, w = 5)

# what are the variences for each PC in each period?
# we don't use CV because that is not good for measurements with no
# absolute zero 
pc_plot %>% 
  group_by(pcn, phase) %>% 
  summarise(variance = var(pc))

# statistical test

pc_plot_tests <- 
  pc_plot %>% 
  group_by_at(vars(-pc)) %>% 
  mutate(i = row_number()) %>% 
  ungroup() %>% 
  mutate(phase = as.character(phase),
         pcn = as.character(pcn)) %>% 
  spread(phase, pc) %>% 
  select(-i) %>% 
  nest_legacy(-pcn) %>% 
  mutate(var_test = purrr::map(data, ~broom::tidy(var.test(.x$`Post-European` ,
                                            .x$`Pre-European`)))) %>% 
  unnest(var_test)
 

library(cvequality)
pc1 <- data.frame(
x  = op.p$x[,1],
y = as.character(op.p$fac$phase),
stringsAsFactors = F)

cv_test_pc1 <- mslr_test(nr = 1000, pc1$x, pc1$y)

pc2 <- data.frame(
  x  = op.p$x[,2],
  y = as.character(op.p$fac$phase),
  stringsAsFactors = F)

cv_test_pc2 <- mslr_test(nr = 1000, pc2$x, pc2$y)

pc3 <- data.frame(
  x  = op.p$x[,3],
  y = as.character(op.p$fac$phase),
  stringsAsFactors = F)

cv_test_pc3 <- mslr_test(nr = 1000, pc3$x, pc3$y)

# do this pairwise
cv_test_pc1.1 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Post-European", 
                               "Pre-European")], 
            pc1$y[pc1$y %in% c("Post-European", 
                               "Pre-European")])

cv_test_pc1.2 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Chinese Contact", 
                               "Pre-European")], 
            pc1$y[pc1$y %in% c("Chinese Contact", 
                               "Pre-European")])

cv_test_pc1.3 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Chinese Contact", 
                               "Post-European")], 
            pc1$y[pc1$y %in% c("Chinese Contact", 
                               "Post-European")])

PC1_cv_tests <- 
bind_rows(cv_test_pc1.1, cv_test_pc1.2, cv_test_pc1.3) %>% 
  bind_cols(phases = c("Post-European vs Pre-European",
              "Chinese Contact vs Pre-European",
              "Chinese Contact vs Post-European"))

cv_test_pc2.1 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Post-European", 
                               "Pre-European")], 
            pc2$y[pc2$y %in% c("Post-European", 
                               "Pre-European")])

cv_test_pc2.2 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Chinese Contact", 
                               "Pre-European")], 
            pc2$y[pc2$y %in% c("Chinese Contact", 
                               "Pre-European")])

cv_test_pc2.3 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Chinese Contact", 
                               "Post-European")], 
            pc2$y[pc2$y %in% c("Chinese Contact", 
                               "Post-European")])

PC2_cv_tests <- 
  bind_rows(cv_test_pc2.1, 
            cv_test_pc2.2, 
            cv_test_pc2.3) %>% 
  bind_cols(phases = c("Post-European vs Pre-European",
                       "Chinese Contact vs Pre-European",
                       "Chinese Contact vs Post-European"))

bind_rows(PC1_cv_tests, 
          PC2_cv_tests, .id = "PC") %>% 
  mutate(PC = str_glue('PC{PC}')) %>% 
  mutate(colour = if_else(p_value < 0.05, "red", "black")) %>% 
  ggplot(aes(str_wrap(phases, 40),
             p_value,
             colour = I(colour),
             shape = PC)
         ) +
  geom_point(size = 8,  position = position_dodge(width = 0.5)) +
  theme_minimal(base_size = 12) +
  coord_cartesian(clip = 'off') +
  xlab("") +
  ylab("CV equality test p-values")

ggsave(here("analysis/figures/cv-test-on-pcs.png"), h = 3, w = 12)

```

Multivariate analysis of variance (MANOVA) is used to test the difference in three shape varaibles from three phases. The result shows significant differences in shape between Pre-European and Post-European (p = 0.02) and Pre-European and Chinese contact shapes (p < 0.01). The distributions of the first three PCs for each vessel suggest variations in shape standardization by period. The first PC, the hight of the vessels, shows more variations in the pre-Euro period compared to the Chinese period. Standardization appears strong in the pre-Euro period but weak in the Chinese period. P-values for a modified signed-likelihood ratio test of equality of CVs of PC1 & PC2 show significant differences in standardization of vessel shape across some periods, especially between Chinese contact with either pre-European or post-European. 

# Discussion

# Conclusion

We find differences in shape and shape standardization of pottery that indicate changes in pottery production resulting from foreign contact, suggesting increasing craft specialization and changes in local social organization at Kiwulan. These results are important to understand the influence of culture contact on local indigenous societies and answer the anthropological question that concerns the the mechanisms for social changes. In addition, our case study, which includes an openly available research compendium of R code suitable for use with any other assemblage, will help to expand the use of shape-based quantitative methods to questions about craft specialization and standardization in prehistoric technologies.

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```

Word count: `r wordcountaddin::word_count()`
