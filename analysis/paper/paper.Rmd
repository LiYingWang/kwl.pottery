---
title: "Standardization of ceramic shape: A case studay from the Iron Age pottery from northeastern Taiwan"

author:
  - Li-Ying Wang
  - Ben Marwick
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  The emergence of ceramic specialization in prehistoric societies is often linked to shifts in the complexity of social structures, because standardized ceramic production can reflect craft specialization and the presence of elite control. Previous work on identifying specialization relies on typological or linear metric analysis. Here we demonstrate how to investigate ceramic standardization by analyzing outlines of ceramic vessels. Outline analysis is useful because, unlike more commonly-used landmark analysis methods, it can effectively quantify shape differences for objects that lack distinctive measurement points needed for landmark analysis. We demonstrate this method using pottery from Kiwulan, a large multi-component Iron Age site (AD 1350-1850) in northeastern Taiwan. To measure ceramic specialization, we quantified pottery standardization by analyzing shape variables with reproducible geometric morphometric methods. We computed coefficients of variation (CVs) for shape coefficients obtained by elliptical Fourier analysis to test for shape standardization. We found significant differences in pottery shape and shape standardization that indicate changes in pottery production resulting from contact with mainland Han Chinese groups in northeastern Taiwan. Our case study, which includes an openly available research compendium of R code, represents an innovative application of outline-based methods in geometric morphometry to answer the anthropological questions of craft specialization. 
keywords: |
  Geometric Morphometrics; craft specialization; Iron age; culture contact; ceramic standardization
highlights: |
  1. Iron Age pottery shapes from Kiwulan, Taiwan, were analyzed using elliptical Fourier analysis
  2. Statistical test for the equality of coefficients of variation of shape coefficients was applied
  3. Significant differences in pottery shape were identified between culture contact phases
  4. Pottery shapes show high standardization after contact with mainland Han Chinese groups
  
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  dpi = 300,
  fig.path = "../figures/"
)

image_width_1_col_inch = 90/25.4 # image Single column	w = 90 mm 
image_width_2_col_inch = 190/25.4 # image Double column w = 190 mm 
```

# Introduction

A major historical factor of social change in small-scale societies is often linked to the introduction of foreign or exotic trade goods to local Indigenous societies [@Mullins2011]. Monopolization of long-distance trade goods has caused substantial transformations in Indigenous economic, cultural, and socio-political systems [@Dietler2005; @Dietler1997; @Junker1993; @Silliman2005]. Pericolonial archaeology is the study of these indirect effects of colonialism, investigating areas where direct European colonial rule was limited, their conquests were often short-lived and unsuccessful, but commercial activities yielded economic and political impacts on Indigenous peoples living on the periphery of colonial control [@Acabado2017; @Trabert2017]. Pericolonial situations were common during the 17th to 19th centuries in East and Southeast Asia where European trading activity was extensive, but direct European rule less widespread. An emerging priority in archaeological research in Asia is identifying the indirect influences that are apparent on Indigenous communities during the colonial period. For example, @Acabado2017’s study of Ifugao society in the Philippines highland suggests economic and political intensification during the Spanish presence in the lowlands as a strategy of Indigenous peoples to resist Spanish conquests.

Indigenous societies' responses to colonial contact ranges from passive acceptance to active negotiation with the colonists, and accommodation or resistance of foreign intrusion [@TorrenceandClarke2000]. The responses can be identified through their daily cultural practices, such as their consumption patterns of foreign goods [@Dietler2015; @Given2004; @Mullins2011; @Scaramelli2005; @Silliman2001]. In this paper we investigate the archaeology of a pericolonial situation at Kiwulan (ca. AD 1350-1850) [@Chen2007], a large multi-component archaeological site in Yilan County, northeastern Taiwan, to identify the indirect impacts of colonial settler activity on local Indigenous societies. Yilan is an ideal context to study peripheral colonial influences because the Indigenous communities were isolated by geographical barriers, limiting the frequency of direct contact with the Spanish and the Dutch settlers in northern Taiwan [cf. @Berrocal2020]. Kiwulan is situated on a hill near a riverside at the northern margin of Yilan County, which is characterized by a triangular alluvial plain facing east toward the Pacific with high mountains on three other sides. 

This research investigates if there was increasing ceramic specialization resulting from Indigenous interaction with Europeans in the 17th century or Chinese in the 19th century, two major foreign influences in early historical Taiwan, which may indicate social changes in Indigenous societies. We predict that competition within the Indigenous community at Kiwulan for foreign resources and trade partnerships with European or Chinese colonizers may have led to the emergence of craft specialization caused by greater economic and social control of ceramic production by a small group of individuals. Using standardization in ceramic shapes as a proxy for craft specialization, we ask: Did colonial trade impact the shape of locally-produced Indigenous pottery vessels? Did pottery shape become more statistically homogeneous after foreign contacts with European colonizers or Chinese immigrants?

Several measurements have been used for investigating ceramic standardization that include metric, compositional, and technological variables [@Arnold2000; @Blackman1993; @Boness2015; @Costin1991; @Rice1991; @Roux2015; @Tite1999]. Among those variables, metric measurements are most widely applied to archaeological assemblages. The coefficient of variation (CV) statistic is regularly used to quantify the degree of standardization in ceramic assemblages [@Eerkens2001; @Roux2003; @Stark1995; @Junker1999]. However, because pottery vessels typically have curved shapes, linear measurements have limited sensitivity to many kinds of shape variations. Thus, to capture subtle shape variations that might also be relevant to standardization, we analyze ceramic shapes using geometric morphometric methods (GMM). 

## Geometric Morphometrics

Geometric morphometrics (GMM) differs from traditional linear measurements through its use of Cartesian coordinates of morphological structures to quantify and analyze shape [@Adams2004; @Bookstein1997; @Lawing2010; @Slice2007]. Landmarks, curves or outlines of objects can be represented by coordinates in terms of their unique point locations with respect to numerical values on coordinate axes. There are two common morphometric methods: landmark and outline approaches [@Adams2004]. Landmark GMM approaches assign a set of landmarks and/or semilandmarks onto objects as reference points. Generalized Procrustes analysis (GPA) is used to superimpose landmark data on a common coordinate system by translating, rotating, and scaling [@Bookstein1991]. After the procedure of GPA, superimposed landmark coordinates become shape variables that allow further statistical analyses [@Slice2007]. A common procedure is using dimensional reduction techniques, such as Principal Components Analysis or Canonical Variate Analysis, to capture the key features that represent the overall shape. Visualization of the reduced data enables the identification of groups, followed by statistical tests to robustly distinguish them. Landmark-based morphometrics have been widely applied to archaeological objects with obvious morphological features that provide unambiguous reference points for landmark placement, such as tips and edges of stone or metal tools [@Birch2019; @Lycett2013], visually distinctive bone features [@Haruda2019; @Meloro2015], or ceramic assemblages with distinct components [@Selden2019; @Topi2017]. GMM is often used to answer research questions related to lithic typological and technological change [@Doyon2019; @Eren2015; @Selden2018lithic; @Perez2007; @Presnyakova2018], animal domestication or mobility [@Haruda2019; @Owen2014], or hominid activities through cutmarks and taphonomic traces [@Aramendi2019; @Courtenay2019]. 

Key questions in archaeological shape analysis normally involve measuring shape standardization over time, or between geographical areas. Standardization is often investigated using multivariate analysis of shape variables computed from landmark data, coupled with coefficients of variation on associated metric data, especially for lithic assemblages. For example, @Archer2015's case study of stone points in Southern Africa suggests an increase in shape standardization over time that may relate to increased maintenance of finished points. @Buchanan2018 analyzed lithic morphology with metric data and identified a more uniform base-shape of Folsom points compared to Clovis points across the western US [@Buchanan2019]. With similar methods, @Smith2016 found standardized bases of fluted point in Alaska and northern Yukon that might indicate a risk management strategy to ensure the ease of replacement during long-distance travel. Other factors, such as low levels of cultural innovation in a small group, could also lead to an increase in standardization of point shapes [@Okumura2014]. To test the effectiveness of measuring standardization, @Birch2019 compared landmark-based GMM to traditional metric analysis with CV using European iron weapons as an example. They demonstrated that landmark-based GMM can capture more variation in not only overall shape, but also bilateral symmetry.

For ceramics, @Topi2017 identified that two types of the Casas Grandes vessels in northwest Mexico tend to have standardized shapes using coefficients of variation for the positions of semi-landmarks across shape groups. They suggested standardization might hint the presence of specialized producers, reflecting social complexity. Another way to explore standardization is pairwise testing of variations in morphological disparity between shape groups by calculating their distances in morphospace, an n-dimensional space where shape groups occupy [@Wills2001]. In this manner, @Selden2018ceramic2 examined Caddo ceramics in northeast Texas using semi-landmark approaches and found am increase in shape standardization over time, providing a basis for further discussion of craft specialization or group identity [@Selden2019]. Similarly, a lithic case study suggests that the Gahagan bifaces from the central Texas exhibit less size standardization than those from the southern Caddo area, indicating different uses or tool types [@Selden2020]. Other applications, such as the study of cranial deformation, demonstrate that landmark approaches with multivariate analyses of shape variances are useful to evaluate shape standardization [@Kuzminsky2016; @Natahi2019; @Perez2007]. 

A key limitation of landmark approaches in archaeology is that landmarks may be difficult to reproducibly locate for structures that are mostly or entirely curves if not mathematically-defined. In those cases, outline approaches, such as Elliptic Fourier Analysis (EFA), is more effective for assessing morphological variations in the whole structure of two-dimensional closed shapes [@Cardillo2010]. EFA uses periodic functions to capture geometric information, where an outline is decomposed into a series of ellipses described by trigonometric functions [@Adams2004; @Bonhomme2014; @Claude2008]. That is, coordinates along a curve are converted into Fourier function coefficients, called harmonic coefficients or harmonics [@Kuhl1982]. The number of harmonics determines the quality and precision of the geometric representation of an object. The harmonic power, a cumulative sum of squared harmonic coefficients, provides a robust rule for determining the desired number of harmonics [@Bonhomme2014]. The first systematic use of Fourier series to analyze shapes of artifacts in archaeology was @Gero1984's study of lithic flakes in Peru. They successfully identified the changes in tool shape from a more angular to rounded shape over time. Later, @Saragusti2005 introduced more functions allowing the calculation of the specific shape attributes, such as symmetry, roughness, and deformation. This presents the potential of EFA for the analysis of curves in detail. @Iovictua2009 demonstrated a protocol, including outline digitization, EFA procedure, and multivariate linear regression, to compare resharpening trajectories of European Middle Paleolithic stone tools. They found that resharpening can be independent of morphology, suggesting functional attributes should be studied separately. Recent case studies further support that EFA is applicable and effective to examine lithic assemblages, such as typological classification of Late Woodland points [@Fox2015], the function of flaked obsidian tools in Easter Island [@Lipo2016], the shape and symmetry standardization of the British Acheulean [@Hoggard2019], and the cultural taxonomies for the European Late Palaeolithic [@Ivanovaite2020].

Despite rare ceramic studies using EFA, this approach is promising for analyzing ceramic taxonomy and standardization. For example, @Wilczek2014 evaluated the concordance between EFA and Discrete Cosine Transform (DCT), and a traditional typology by studying 154 complete ceramic vessels with varied shapes from the Bibracte oppidum in France. The results present that the variation indicated by EFA and DCT matches the traditional ceramic typology, which supports the claim that outline-based approaches can be efficiently used for studying variations in ceramic shapes. Furthermore, @Wilczek2014 pointed out the potential of EFA for detecting the level of ceramic standardization. In this paper we use EFA to evaluate the level of standardization of ceramics data from Kiwulan, northeastern Taiwan, in relation to the foreign colonial presences to gain insights into the emergence of ceramic specialization. Since our ceramic sample lacks sufficient landmarks that could be identified straightforwardly due to their globular body, EFA is a suitable method by focusing the overall shape of an artifact. In addition, we use a significance test for the equality of coefficients of variation of shape variables to statistically compare the vessel standardization from different periods.

# Archaeological background and materials 

Ceramics analyzed in this study come from 40 units (4m by 4m each) sampled from the central, undisturbed area of archaeological excavations at Kiwulan (Figure \@ref(fig:KWL-map); Figure \@ref(fig:KWL-sam-area)). The chronology of the archaeological deposits consists of two cultural components, the upper and the lower, with a sterile layer in between [@Chen2007]. We focus on the upper component, dated from AD 1350 to 1850, spans the late Iron Age and the historical period. The historical period in Taiwan started with the presence of the Europeans in the early 17th century. The Dutch first occupied southern Taiwan in 1624, followed by the Spanish in northern Taiwan in 1626 [@Andrade2007]. In 1642, the Spanish was expelled by the Dutch, who then occupied the previous Spanish forts at Helping Dau in Keelung, and in Tamsui. Western Taiwan remained under Dutch colonial rule until 1662 when the Kingdom of Tungning in Taiwan was founded by Koxinga, a loyalist of the Ming dynasty of China [@Andrade2007]. 

```{r, KWL-map, fig.cap = "Map illustrating the location of Kiwulan, and other locations in northern Taiwan that are named in the text. Map data is from naturalearthdata.com", fig.width=image_width_2_col_inch}
library(here)
knitr::include_graphics(here("analysis", "figures", "kiwulan-location-map.jpg"))
```

```{r, KWL-sam-area, fig.cap = "Map showing the largest section of excavation areas at Kiwulan, and the distribution of forty squares sampled in this paper presented in red with square ID number. Small dots represent the location of post-holes. Each square is 4 x 4 m", fig.width=image_width_2_col_inch}
knitr::include_graphics(here("analysis", "figures", "KWL-excavation-map.jpg"))
```

```{r}
library(readxl)
library(tidyverse)
thin_section <- read_excel(here::here("analysis", "data", "raw_data", "kwl_petrography.xlsx"), 2)
sherd <- read_excel(here::here("analysis", "data", "raw_data", "kwl_petrography.xlsx"), 1)

# sum the columns of similar minerals
thin_section_combine <-
  thin_section %>%
  mutate(Quartz = `Monocrystalline quartz` + `Polycrystalline quartz`,
         Argillite_all = `Argillite` + `Reddish-brown Argillite`)

# prepare data for pca
thin_section_combine_pca <-
  thin_section_combine %>%
  select(4:5, 8:12, 17:18)

# PCA
pca1 <- prcomp(thin_section_combine_pca, scale. = TRUE)
# add phase
pca1$phase <- as.factor(thin_section_combine$phase)

# MANOVA
man_pca <- manova(pca1$x ~pca1$phase)
sum_man_all <- summary(man_pca, test="Pillai")

# get p value
sum_man_all_df <-
  as.data.frame(sum_man_all[4]) %>%
  mutate_if(is.numeric, round, 4) %>%
  select(-`stats.Df`, -`stats.num.Df`) %>%
  rename(`Pillai's trace` = `stats.Pillai`,
         `Approximate F value` = `stats.approx.F`,
         `degrees of freedom` = `stats.den.Df`,
         `Pr(>F)` = `stats.Pr..F.`)

pval_all <- signif(unname(sum_man_all_df[,'Pr(>F)'][1]), 4)
```

The archaeological record of Kiwulan's upper component shows traces of foreign contact, including Europeans in the 17th century, and waves of Chinese immigrants in the 19th century. Imported ceramics from mainland China, stoneware, and ornaments such as beads have been recovered in the upper component, indicating frequent long-distance trade activities with Europeans and Chinese merchants. Archaeological features such as burials, middens, and post-holes with _in-situ_ posts are widespread across the 1-2 m thick deposit of the upper component, and demonstrate that Kiwulan was a continuously occupied large settlement site [@Chen2007]. To compare different foreign influences, we classified the upper component into three chronological phases: pre-European, European, and Chinese. These phases were identified according to chronologically diagnostic artifacts based on their fined-grained time scale. Despite the availability of 17 radiocarbon ages [@Chen2007], the chronological model demonstrates that time range are too coarse to provide sufficient information for the separation of three phases [@WangandMarwick2020]. Thus, radiocarbon ages only serve as a cross-validation for the diagnostic artifacts if applicable. The diagnostic artifacts include blue and white porcelains, light grey glazed jars, and large dark brown glazed stoneware jars commonly used in the 17th century, and bricks and tiles employed by the Chinese in the 19th century [@Chen2007; @Hsieh2009; @Wang2011]. We also examined excavation depth measurement and stratigraphic details reported by the excavators (color, texture, disturbance, etc.) to reliably separate three phases. The deposit exhibited signs of continuous human occupation in each of the three phases with no apparent breaks. More details for the assignment of different phases are in the Online Supplementary Materials. 

The most abundant artifacts in the upper component are locally manufactured ceramics, which are distributed throughout the temporal sequence, and across the study area. More than 550,000 sherds were revealed, and around 1,200 vessels could be completely or partially reconstructed (i.e. complete rim or base). There are two shapes of locally-manufactured vessels; a cooking pot and a steamer made of two cooking pots stacked together with a clay filter between. Those vessel shapes demonstrate suites of standard morphological components. Each has a globular body with a short neck and wide mouth (Figure \@ref(fig:KWL-pots)). The exterior surface below the neck is decorated with a variety of impressed geometric motifs. These vessels were potentially used for cooking indicated by evidence of the frequent presence of charred residues and carbon deposits on vessel interiors, and soot on vessel exteriors. Firing resulted in orange and brownish color with a fully oxidized core, or a reduced core with oxidized fringes [@Chen2007]. The vessels were believed to be made with pinching technique according to some hand-shaped traces on vessel interiors, such as finger impressions and seams. This kind of vessel has been widely found at archaeological sites during the late Iron Age and the historical period throughout the Yilan Plain [@NMTH2005].

Petrographic analysis for 34 thin sections presents a high percentage of inclusions (15-50%), including argillite (15-40%), metasandstone (1-10%), sandstone fragments (1-6%), quartz (1-5%), and trace amounts of feldspar and slate. Particle sizes range from 500 to 1300 microns. In general, the vessel fabric presents a mixture of fine, rounded argillite with a small amount of rounded metasandstone and rounded sub-angular monocrystalline quartz. This composition is consistent with the mineralogical composition of local raw materials found in the Yilan Plain [@Chen2016]. There are no significant changes in the inclusions over time, indicating continuity in pottery fabric composition across the three periods (p = $`r pval_all`$) [@WangandMarwick2020]. 

```{r, KWL-pots, fig.cap = "A typical pot from Kiwulan (left) and an example of a pottery drawing used for outline analysis (right)", fig.width=image_width_2_col_inch}
knitr::include_graphics(here("analysis", "figures", "pots.png"))
```

```{r tidy-data}
# Once we have the jpgs, start from here
# read in pottery data
pottery_data <- readr::read_csv(here("analysis/data/raw_data/KWL_Ceramic_final2018_with_phases.csv"))

# get list of jpgs only
jpgs <- list.files(here("analysis/data/raw_data/outline_jpg"), pattern = ".jpg", full.names = TRUE)

# join file names to phase
pottery_data <- pottery_data %>% 
  mutate(filename = str_glue('fill_{filename}.svg_output.jpg'))

# some outlines that we have no phases for... 
sdiff <- setdiff(pottery_data$filename, basename(jpgs))

# the ones we do have both outlines and phases
isect <- intersect(pottery_data$filename, basename(jpgs))

jpgs <- jpgs[basename(jpgs) %in% isect]
pottery_data <- 
  pottery_data %>% 
  filter(filename %in% isect) %>% 
  distinct(filename, phase, .keep_all = TRUE)

phases_isect <- 
  pottery_data %>%  
  dplyr::select(filename, phase) %>% 
  filter(filename %in% isect) %>% 
  mutate_all(as.factor) %>% 
  distinct(filename, phase) %>% 
  mutate(phase = as.factor(case_when(
    phase == 'post-e' ~ "Post-European", # include European period and after it before Chinese contact
    phase == 'pre-e' ~ "Pre-European",
    phase == 'ch-con' ~ "Chinese" # we can combine Chinese and post-Euro
  ))) 

# how many pots in each phase?
phase_fre <- phases_isect %>% 
  group_by(phase) %>% 
  tally(sort = T)

total_no <- sum(phase_fre$n)
pre_no <- phase_fre$n[1]
Euro_no <- phase_fre$n[2]
Chi_no <- phase_fre$n[3]
```

# Methods

The sample consists of `r total_no` reconstructed vessels with rim, body and base parts, and we securely provenanced to pre-contact (n = `r pre_no`), post-European (n = `r Euro_no`), and Chinese contact contexts (n = `r Chi_no`).

## Digitizing and analyzing by EFA

We used scans of pottery drawings at 300 dpi acquired from the Bureau of Cultural Affairs in Yilan (Figure \@ref(fig:KWL-pots)). All drawings provide a two-dimensional view of vessel cross-sections based on metric measurements. The scanned drawings were imported into Inkscape (http://inkscape.org) for digitization where outlines were manually traced. In those instances where only one side of the cross-section image was available, or some sections were missing, we interpolated the curves and then mirrored and joined to create a closed outline for each vessel. Analyses were conducted in R software (R Core Team, 2019) using functions included in the Momocs package for quantifying and analyzing shapes [@Bonhomme2014]. Outlines were converted into a list of successive x, y pixel coordinates for EFA. We analyzed harmonic coefficients by principal component analysis (PCA) for dimensionality reduction to illustrate the diversity of the shape data and identify major patterns of variation. 

## Statistical analysis 

The principal component (PC) scores were analyzed with a multivariate analysis of variance (MANOVA) to test significant differences in shapes between occupation phases. We also computed coefficients of variation values (CVs) for the PCs, treating the PCs as shape variables that are more informative than linear dimensions. The coefficient of variation is a common and widely-used statistical measure of the spread of a set of measurements of a sample. It is defined as the standard deviation divided by the mean:

$$c_v = \frac{\sigma}{\mu}$$

As a standardized measure of the spread of data, coefficients of variation (CV) allows a direct comparison for variation in samples measured with different units or means. This is useful to examine the degree of standardization for archaeological assemblages and enables comparison of variation across different sample sizes [@Eerkens2001, pp.498]. Following @Eerkens2001 and @Roux2003, we take this as our measurement of standardization in vessel shape variables: lower CV values reflect higher standardization, and thus increased craft specialization in the community. Given that CV is robust for positive values due to the representation by a ratio scale, we normalized PC scores to a range between 1 and 10 for the computation of CV.

To answer the question of whether CV values of vessel samples across our three occupational phases are significantly different or not, we used the modified signed-likelihood ratio (MSLR) test for equality of CVs [@Krishnamoorthy2014]. While previous work has used the @Feltz1996's asymptotic test for the equality of coefficients of variation from k populations [@Eerkens2000; @Eerkens2001; @Hoggard2017; @Lycett2008; @Okumura2014], we prefer the MSLR test for shape variables as a more recent development with lower rates of type I error, better performance with uneven sample numbers, and more power across a range of conditions [@Krishnamoorthy2014]. 

To complement our investigation of craft specialization through shape standardization, we investigated spatial patterns of ceramic vessels at Kiwulan. As craft specialization increases, pottery distribution we expect a shift from a pattern of vessels dispersed across the site to a pattern of clusters that reflects the loci of production [@Costin2001]. We used a Monte Carlo test for randomness in spatial locations of ceramics to robustly test whether their distribution is significantly clustered or dispersed. 

# Reproducibility and open source materials 

To enable re-use of materials and improve reproducibility and transparency [@Marwick2017], the entire R code [@Rlanguage2019] used for all the analysis and visualizations contained in this paper is openly available online at https://doi.org/10.17605/OSF.IO/ABVGF [@WangandMarwick2020]. Also in this version-controlled compendium [@Marwick2018] are the raw data for all the visualizations and tests reported here. All of the figures, tables, and statistical test results presented here can be independently reproduced with the code and data in this repository. The code is released under the MIT license, the data as CC-0, and figures as CC-BY, to enable maximum re-use. 

# Results

```{r jpg-coordinates, eval=FALSE}
# this takes some time, so we don't run the code each time we knit, we run it once and save the output
# start shape exploration
library(Momocs)
#  it freezes on the empty ones...
jpgs_imported <- import_jpg(jpgs, threshold = 0.5)

# Normalise the shapes, from 
# https://www.repository.cam.ac.uk/bitstream/handle/1810/266423/Supplementary%20Code%20S1.pdf?sequence=20&isAllowed=y
jpgs_imported_coo <- 
  jpgs_imported %>% 
   Out(., fac = phases_isect)  %>% 
  # Centring, scaling and sampling pseudo-landmarks
   coo_center %>% 
   coo_scale %>% 
   coo_sample(., 1000) %>% 
  # Procrustes superimposition for pseudo-landmarks
   fgProcrustes %>% 
  # Normalization of the starting points
   coo_slidedirection

saveRDS(jpgs_imported_coo,
        here("analysis/data/derived_data/jpgs_imported_coo.rds"))
```

<!-- basic description of shape -->

Thirteen harmonics captured 99% of the total harmonic power in the elliptic Fourier coefficients of `r total_no` vessels from three discrete phases. Figure \@ref(fig:first-two-PCs-byplot-and-tps-plot) illustrates differences in vessel shapes described using thin-plate spline warping for paired periods, pre- and post-European periods, and post-European and Chinese periods, with the greatest differences evidenced between pre-European and Chinese periods.

```{r thin-plate-splines}
# Thin plate spline analysis (TPS)
# visualize the outline deformations required to pass from an extreme of the morphospace to the other
# Deformation grids

# Mean pottery shapes of three phases
library(Momocs)
library(cowplot)
jpgs_imported_coo <- readr::read_rds(here("analysis/data/derived_data/jpgs_imported_coo.rds"))

# default is 13 harmonics that gather 99% of the harmonic power
op <- efourier(jpgs_imported_coo, norm = FALSE, 13)


# mean shape, per group
pot.ms <- MSHAPES(op, 'phase')
mshp <- pot.ms$shp
names(mshp) <- c("chi", "poe", "pre")

`Post-European` <- mshp$poe
`Pre-European` <-  mshp$pre
`Chinese` <-       mshp$chi

# save figure
source(here("analysis/code/my_tps_grid.R"))
png(here("analysis/figures/tps-iso.png"), res = 300, w = 1800, h = 1000)
par(mfrow=c(2,1)) # plot them side by side

my_tps_grid(`Pre-European`, 
         `Post-European`, 
         shp.lwd = c(2, 2), 
         shp.border = c("red", "blue"),
           amp = 1, 
         grid.size = 18, 
         legend = T)

my_tps_grid(`Pre-European`, 
         `Chinese`, 
         shp.lwd = c(2, 2), 
         shp.border = c("red", "blue"),
           amp = 1, 
         grid.size = 18, 
         legend = T)

# Isodeformation lines
invisible(dev.off())
```

```{r PCA-table}
# these are fast
op.p <- PCA(op)
# proportion of variances explained, PC1 and PC2 explain 79% of variation
pro_vari <-scree_plot(op.p)$data
pc1 <- round(pro_vari$proportion[1],4)*100
pc3 <- round(pro_vari$proportion[3],4)*100
vari_two <- round(pro_vari$cumsum[2],4)*100
vari_three <- round(pro_vari$cumsum[3],4)*100
```

<!-- further description of shape and differences between phases -->

The first two principal components (PCs) of the PCA on the elliptic Fourier coefficients explain `r vari_two`% of the total variance, of which `r pc1`% is explained by the first principal component. With the third component, the first three principal components explain `r vari_three`% of the total variance. PC1 captures the height of the vessels, from tall to short, and the roundness of the body from round to oval-shaped (Figure \@ref(fig:first-two-PCs-byplot-and-tps-plot)). PC2 relates to the neck and mouth constriction, from narrow to wide. PC3 explains a smaller portion of the variance (`r pc3`%), which relates to the degree of the flare in the neck, from a curved to a straight shape. The results reflect a large overlap in shapes from three occupations phases, especially for shapes in the pre-European and post-European periods. However, the spread of shape distribution indicates a wider variation in shapes in the pre-European and post-European periods compared to those in the Chinese period along both PC1 and PC2 axes. In other words, we find a decrease in shape variance in the Chinese period evidenced in the shorter height and narrower mouth of vessels used in that period.

```{r}
# PCA byplot, we save it to disk to use in the next chunk
png(here("analysis/figures/pca-chull.png"), res = 300, w = 1800, h = 1000)
plot_PCA(op.p, ~phase, chullfilled = TRUE)
invisible(dev.off())
```

```{r}
library(magick)
# composite composite image of thin plate spline and PCA output
iso_plot <- image_read(here("analysis/figures/tps-iso.png"))
iso_plot <- image_trim(iso_plot)
pca_plot <- image_read(here("analysis/figures/pca-chull.png"))

iso_plot_back <- image_scale(image_background(iso_plot, "none"), 360)
iso_pca <- image_composite(pca_plot, iso_plot_back, offset = "+50+50")
iso_pca_crop <- image_crop(iso_pca, geometry = geometry_area(1800, 750, 0, 0))
image_write(iso_pca_crop, here("analysis/figures/iso_pca_composit_crop.png"))
```

```{r, first-two-PCs-byplot-and-tps-plot, echo=FALSE, fig.cap='Left: Significant differences in average vessel shapes between the Chinese and the post-European period using thin plate splines (TPS) with outline deformations required to pass from an extreme of one morphospace to another. Right: Pottery shape distribution by each occupation phase according to the first two PCs.'}
knitr::include_graphics(here("analysis/figures/iso_pca_composit_crop.png"))
```

```{r MANOVA-table}
# MANOVA: Multivariate Analysis of (co)variace
# We can test for a difference in the distribution of PC scores by calculating a pairwise combination between every levels of a fac. 

manv <- rrtools:::quietly ( MANOVA_PW(op.p, "phase") ) 
su_manv <- as.data.frame(manv$summary) %>% 
  rownames_to_column()

su_manv_tab <- 
  su_manv %>% 
  mutate_if(is.numeric, round, 4) %>% 
  select(-Df, -`num Df`) %>% 
  rename(Comparison = rowname,
         `Pillai's trace` = Pillai,
         `Approximate F value` = `approx F`,
         `degrees of freedom` = `den Df`) 

pval_chi_pre <- signif(unname(su_manv_tab[,'Pr(>F)'][2]), 4)
pval_post_pre <- signif(unname(su_manv_tab[,'Pr(>F)'][3]), 4)

knitr::kable(su_manv_tab,
             caption = "Summary statistics for the MANOVA test on the PC scores. `Pr(>F)` is the p-value associated with the F statistic of the effect and test statistic. ")
```

<!-- statistical test of difference in shape described in previous paragraph -->

To test for differences in the distributions of shape variables indicated by the PC scores shown in Figure \@ref(fig:first-two-PCs-byplot-and-tps-plot), we used a multivariate analysis of variance (MANOVA) test to compare pairwise combinations across the three occupation phases. Table \@ref(tab:MANOVA-table) demonstrates the significant differences in shape between Pre-European and Post-European phases (p = $`r pval_post_pre`$), and Pre-European and Chinese phases (p = $`r pval_chi_pre`$). These results are consistent with the differences in the visualization of average shapes between the phases (Figure \@ref(fig:first-two-PCs-byplot-and-tps-plot), see left). Although there is considerable overlap of shape variables between the Pre-European and Post-European phases, their PC scores differ significantly. There is no significant difference in vessel shapes between the Post-European and Chinese contact periods. 

<!-- CV equality testing -->

To compare pottery shape standardization across the three phases we investigated the distributions of the first three PC scores, taking the PC scores as proxy variables for vessel shape (Figure \@ref(fig:PCs-distribution)). The CVs calculated of the three PC support a general trend toward a more standardized shape over time, especially the shape identified by PC1 that represents vessel height and roundness. The PC1 shows a higher variation in the pre-European period and post-European period compared to the Chinese period. That is, a more standardized shape found in the Chinese period. However, the PC2 presents a similar diversity in ceramics assemblages across three phases, while the PC3 demonstrates a slightly standardized shape in the Chinese period.

To see whether the differences in the distribution of PCs between any two phases are substantive or due to chance, we assessed the equality of CVs for PC1 and PC2 with a modified signed-likelihood ratio test  [@Krishnamoorthy2014; @Marwick2019]. P-values for PC1 show significant differences in shape standardization across periods, between Chinese contact with either pre-European or post-European (Table \@ref(tab:CV-test-PCs-table)). This result statistically supports the observation of a higher standardized shape in the Chinese period. 

```{r PCs-distribution, fig.cap= "The distribution of normalized PC scores by phases with CV values (%)"}

# for one matrix
op.p_tmp <- 
op.p$x %>% 
  as_tibble() %>% 
  mutate_all(~scales::rescale(., to = c(1, 10))) %>% # normalize to 1-10
  as.matrix() 

row.names(op.p_tmp) <- row.names(op.p$x )

op.p$x <- op.p_tmp

# what are the variances for each PC in each period?
len <- length(op.p$x[,1])

# plot PC1-3 distribution by phase
pc_plot <- tibble(pc = c(op.p$x[,1],
                         op.p$x[,2],
                         op.p$x[,3]),
                  phase = rep(op.p$fac$phase, 3),
                  pcn = str_glue('PC{sort(rep(1:3, len))}'))

pc_cv_table <- 
pc_plot %>% 
  group_by(phase, pcn) %>% 
  summarise(cvs = raster::cv(pc)) %>% 
  pivot_wider(names_from = pcn, 
              values_from = cvs)

pc_plot$phase <- fct_relevel(pc_plot$phase, 
                             c("Pre-European", 
                               "Post-European"))

# transform the data to wider format
pc_all_wide  <- 
  pc_plot %>% 
  group_by(pcn) %>% 
  mutate(row = row_number()) %>%
  pivot_wider(names_from = pcn, 
              values_from = pc) %>% 
  select(-row)

# calculate cv for each PC
cv_pcs_all <-
  pc_all_wide %>% 
  group_by(phase) %>%
  mutate(cv_pc1 = round(sd(PC1)/ mean(PC1), digits = 2)*100,
         cv_pc2 = round(sd(PC2)/ mean(PC2), digits = 2)*100,
         cv_pc3 = round(sd(PC3)/ mean(PC3), digits = 2)*100)%>% 
  mutate(mean_pc1 = mean(PC1),
         mean_pc2 = mean(PC2),
         mean_pc3 = mean(PC3)) %>% 
  distinct(cv_pc1, cv_pc2, cv_pc3, mean_pc1, mean_pc2, mean_pc3)

# making the cv label
cv_label <-
  cv_pcs_all %>% 
  mutate(cv_pc1 = paste("CV = ", cv_pc1, "%"),
         cv_pc2 = paste("CV = ", cv_pc2, "%"),
         cv_pc3 = paste("CV = ", cv_pc3, "%"))

cv_label <- c(cv_label$cv_pc1, cv_label$cv_pc2, cv_label$cv_pc3) 

ggplot(pc_plot,
       aes(phase,
           pc)) +
  geom_violin() + 
  ggforce::geom_sina() +
  xlab("") +
  facet_wrap(~ pcn, ncol = 1) +
  geom_text(data = cv_pcs_all,
            mapping = aes(x = c(2.1, 1.1, 3.1, 2.1, 1.1, 3.1, 2.1, 1.1, 3.1), 
                          y = 8.5, 
                          label = cv_label),
            size = 2,
            color= "red",
            hjust = -0.1,
            vjust= -1)+
  theme_minimal()

ggsave(here("analysis/figures/pcs-boxplot-for-shape-variation.png"),
       h = 4, w = 5)
```

```{r CV-test-PCs-table}
library(cvequality)
# CVs on shape PCs for standardization
pc1 <- data.frame(
x = op.p$x[,1],
y = as.character(op.p$fac$phase),
stringsAsFactors = F)

cv_test_pc1 <- mslr_test(nr = 1000, pc1$x, pc1$y)

pc2 <- data.frame(
  x  = op.p$x[,2],
  y = as.character(op.p$fac$phase),
  stringsAsFactors = F)

cv_test_pc2 <- mslr_test(nr = 1000, pc2$x, pc2$y)

pc3 <- data.frame(
  x  = op.p$x[,3],
  y = as.character(op.p$fac$phase),
  stringsAsFactors = F)

cv_test_pc3 <- mslr_test(nr = 1000, pc3$x, pc3$y)

# do this pairwise
cv_test_pc1.1 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Post-European", 
                               "Pre-European")], 
            pc1$y[pc1$y %in% c("Post-European", 
                               "Pre-European")])

cv_test_pc1.2 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Chinese", 
                               "Pre-European")], 
            pc1$y[pc1$y %in% c("Chinese", 
                               "Pre-European")])

cv_test_pc1.3 <- 
  mslr_test(nr = 1000, 
            pc1$x[pc1$y %in% c("Chinese", 
                               "Post-European")], 
            pc1$y[pc1$y %in% c("Chinese", 
                               "Post-European")])

PC1_cv_tests <- 
bind_rows(cv_test_pc1.1, cv_test_pc1.2, cv_test_pc1.3) %>% 
  bind_cols(phases = c("Post-European vs Pre-European",
              "Chinese Contact vs Pre-European",
              "Chinese Contact vs Post-European"))

cv_test_pc2.1 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Post-European", 
                               "Pre-European")], 
            pc2$y[pc2$y %in% c("Post-European", 
                               "Pre-European")])

cv_test_pc2.2 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Chinese", 
                               "Pre-European")], 
            pc2$y[pc2$y %in% c("Chinese", 
                               "Pre-European")])

cv_test_pc2.3 <- 
  mslr_test(nr = 1000, 
            pc2$x[pc2$y %in% c("Chinese", 
                               "Post-European")], 
            pc2$y[pc2$y %in% c("Chinese", 
                               "Post-European")])

PC2_cv_tests <- 
  bind_rows(cv_test_pc2.1, 
            cv_test_pc2.2, 
            cv_test_pc2.3) %>% 
  bind_cols(phases = c("Post-European vs Pre-European",
                       "Chinese Contact vs Pre-European",
                       "Chinese Contact vs Post-European"))

PC1_PC2_cv_tests <-
bind_rows(PC1_cv_tests, 
          PC2_cv_tests, .id = "PC") %>% 
  mutate(PC = str_glue('PC{PC}')) %>% 
  mutate(PC = as.character(PC)) %>% 
  mutate_at(c("MSLRT", "p_value"), round, 4)

knitr::kable(PC1_PC2_cv_tests,
             caption = "P-values of the CV equality test of PC1 and PC2 between phases")
```

<!-- size analysis -->

Vessel size is another important variable for detecting standardization, we used the body diameter of vessels as a proxy of size to examine their variations and relationships with vessel shape. We measured body diameter directly from each physical vessel in the collection, and we focus on this metric because it is available for more vessels than any other metric. The body diameter of vessels from the Chinese period is larger than those from the two earlier periods, and the vessels before European contact have the smallest body diameter on average (Figure \@ref(fig:size-shape-regression-plots): A). To investigate vessel form standardization, represented by shape and size, we compared CV for PC1 (shape) in relation to CV for body diameter (size). The result (Figure \@ref(fig:size-shape-regression-plots): B) presents a higher standardization in vessel form in the Chinese period according to smaller CV values compared to those from the other two phases. However, there are no obvious differences in form standardization before and after the European presence. To understand the relationship between shape and size, we modeled linear regression for PCs and the measurement of body diameter, with an examination of Pearson's correlation coefficient and p-value (Figure \@ref(fig:size-shape-regression-plots): C). The results demonstrate that shape changes with size in all phases indicated by moderate positive relationships (0.3 ≤ r ≤ 0.7) and small p-values (≤ 0.05), except for PC1 in the Chinese period and PC2 in the pre-European period. In general, the shorter vessels are larger in body diameter according to the significant positive correlation. However, vessels from the Chinese period do not show this pattern. For the relationship between PC2 and body diameter, the negative relationship suggests that vessels with a narrower neck and mouth tend to have a larger body diameter.

```{r size-analysis-prep-1}
library(ggpubr)

jpgs_imported_coo_size <- coo_centsize(jpgs_imported_coo)
jpgs_imported_coo_size_df <- as.data.frame(jpgs_imported_coo_size) 
jpgs_imported_coo_size_df <-
  bind_cols(filename = rownames(jpgs_imported_coo_size_df), 
            jpgs_imported_coo_size_df) %>% 
  mutate(filename = parse_number(filename))

# prepare metric data for joining
pottery_data_tidy <-
  pottery_data %>%
  mutate_at(vars(starts_with(c("Thick", "Diameter"))), as.numeric) %>% 
  mutate(Height = as.numeric(Hight)) %>% 
  mutate(filename = parse_number(filename))

# prepare pcs dataframe for joining
pc1_df_with_filename <-
  bind_cols(filename = rownames(pc1), pc1) %>% 
  rename(c("pc1" = "x")) %>% 
  mutate(filename = parse_number(filename))

pc2_df_with_filename <-
  bind_cols(filename = rownames(pc2), pc2) %>% 
  rename(c("pc2" = "x")) %>% 
  mutate(filename = parse_number(filename))

# make a dataframe for centroid size and join with pc1
jpgs_imported_coo_size_pcs_metric <-
  jpgs_imported_coo_size_df %>% 
  mutate(filename = parse_number(as.character(filename))) %>% 
  left_join(pc1_df_with_filename) %>% 
  left_join(pc2_df_with_filename) %>% 
  left_join(pottery_data_tidy)
```

```{r cv-metric-table-with-pc1-prep}
# combine with cv information 
size_pcs_cv_join <-
  jpgs_imported_coo_size_pcs_metric %>% 
  group_by(y) %>% 
  mutate(cv_body_diameter = round(raster::cv(Diameter1_Body), 2),
         cv_neck_diameter = round(raster::cv(Diameter1_Neck), 2),
         cv_rim_diameter = round(raster::cv(Diameter1_Rim), 2),
         Diameter1_Body_mean = round(mean(Diameter1_Body), 2)) %>% 
  mutate(phase = as.factor(y)) %>% 
  left_join(cv_pcs_all) %>% 
  left_join(pc1_df_with_filename) %>% 
  select(-y)
  #distinct(phase, cv_pc1, cv_pc2, cv_pc3, Diameter1_Body_mean, cv_body_diameter)
```

```{r boxplot-size-by-phase}
# prepare label
size_cv_df <-
  size_pcs_cv_join %>% 
  distinct(phase, Diameter1_Body_mean, cv_body_diameter, cv_pc1) %>% 
  mutate(cv_body_diameter_label = paste("CV =", cv_body_diameter, "%"),
         Diameter1_Body_mean_label = paste("mean=", Diameter1_Body_mean))

cv_diameter_label <- size_cv_df$cv_body_diameter_label

# size boxplot by period
boxplot_size <-
  ggplot(jpgs_imported_coo_size_pcs_metric,
         aes(Diameter1_Body, fct_rev(y))) +
  geom_boxplot() +
  coord_flip() +
  labs(x = "body diameter\n(mm)", y = "") +
  scale_y_discrete(breaks = c("Pre-European", "Post-European", "Chinese"),
                   labels = c("Pre-\nEuropean", "Post-\nEuropean", "Chinese")) +
  annotate("text", x = c(126,122,144), y = c(2,1,3), 
           size = 2, label = cv_diameter_label) +
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.9)),
        axis.text.y = element_text(size = rel(0.9)))
```

```{r byplot-cvs-pc1-size}
library(ggrepel)
y_limits <- c(NA, 32)
byplot_cvs_pc1_diameter <-
  size_cv_df %>% 
  ggplot(aes(cv_body_diameter, cv_pc1)) +
  geom_point() +
  geom_text_repel(label = size_cv_df$phase, 
                  size = 2.5) + 
  labs(x = "CV of body diameter (%)",
       y = "CV of PC1\n(%)") +
  theme(legend.position = "none") +
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.9)),
        axis.text.y = element_text(size = rel(0.9)))
```

```{r pcs-size-regression}
# can pc1 predict size by period?
pc1_size_reg <- 
  ggscatter(jpgs_imported_coo_size_pcs_metric, 
            x = "Diameter1_Body", 
            y = "pc1",
            add = "reg.line",
            size = 1) +
    facet_wrap(~ fct_rev(y)) +
    stat_cor(label.y = 11, 
             label.sep = ", ",
             size = 2) +
    #stat_regline_equation(label.y = 1) +
    labs(x = "", y = "PC1") +
    theme(axis.text = element_text(size = 8)) +
    scale_y_continuous(limits = c(0, 12),
                       breaks = c(seq(0, 10, 2)),
                       labels = c(seq(0, 10, 2)))

# can pc2 predict size by period?
pc2_size_reg <- 
  ggscatter(jpgs_imported_coo_size_pcs_metric, 
            x = "Diameter1_Body", 
            y = "pc2",
            add = "reg.line",
            size = 1) +
    facet_wrap(~ fct_rev(y)) +
    stat_cor(label.y = 11, 
             label.sep = ", ",
             size = 2) +
    #stat_regline_equation(label.y = 1) +
    labs(x = "body diameter (mm)", y = "PC2") +
    theme(axis.text = element_text(size = 8)) +
    scale_y_continuous(limits = c(0, 12),
                       breaks = c(seq(0, 10, 2)),
                       labels = c(seq(0, 10, 2)))
```

```{r plot-size-regression-together}
# plot boxplot and regression together 
left_column <-
  plot_grid(boxplot_size, byplot_cvs_pc1_diameter, 
            ncol = 1, rel_heights = c(1.1,1), 
            labels = c("A", "B"), label_size = 12 )

right_column <-
  plot_grid(pc1_size_reg, pc2_size_reg, ncol = 1)

size_boxplot_regression <-
  plot_grid(left_column,
            right_column,
            labels = c("", "C", "B"),
            label_size = 12,
            rel_widths = c(1.8, 3.7))

ggsave(plot = size_boxplot_regression,
       here("analysis", "figures",
            "plot-size-boxplot-regression.jpg"),
       width = 180, 
       height = 100,
       dpi = 300,
       units = "mm")
```

```{r, size-shape-regression-plots, echo=FALSE, fig.cap= "A: Distribution of the body diameter of vessels with coefficients of variation by phases. B: Coefficients of variation of vessel shape represented by PC1 in relation to vessel size represetnted by body diameter, showing a more standardization in vessel form in the Chinese period. C: Correlation between shape variables (PC1 and PC2) and body diameter of vessles with Person's r and P-values by phases"}
knitr::include_graphics(here("analysis/figures/size-boxplot-regression.jpg"))
```

```{r morphological-disparity}
require(dispRity)
phases_list <-
  list("Pre-European" = which(op.p$phase == "Pre-European"),
       "Post-European" = which(op.p$phase == "Post-European"),
       "Chinese" = which(op.p$phase == "Chinese"))

disparity_data <-
  dispRity.per.group(op.p$x,
                     group = phases_list,
                     metric = c(sum, variances))

disparity <-
  test.dispRity(disparity_data,
                test = wilcox.test,
                correction = "bonferroni",
                details = TRUE)

pre_chi <- signif(disparity[[2]][[1]]$p.value, 4)
post_chi <- signif(disparity[[3]][[1]]$p.value, 4)
```

```{r poisson-linear-model}
total_potsherds <- read.csv(here("analysis", "data", "raw_data", "Kwl_total_potsherds.csv"))

# poisson model
fit <- glm(formula = sum_pot ~ cv_pc1,
           family = "poisson",
           data = total_potsherds)

pval <- unname(coef(summary(fit))[,'Pr(>|z|)'][2])
# how to print with a reasonable number of significant figures:
pval_print <- signif(pval, 4)

beta <- unname(coef(summary(fit))[,'Estimate'][2])
# how to print with a reasonable number of significant figures:
beta_print <- signif(beta, 4)
```

```{r decoration-by-phase}
pottery_deco_table <-
  pottery_data_tidy %>%
  select(Pit, Layer, `No.`, phase, `紋飾/腹片`) %>%
  mutate(`紋飾/腹片`= str_remove_all(`紋飾/腹片`, "[[:punct:]]")) %>%
  count(phase, `紋飾/腹片`, name = "count") %>%
  group_by(phase) %>%
  mutate(sum = sum(count))

pottery_deco_count <-
  pottery_deco_table %>%
  count(phase, sum, name = "decoration_types") %>%
  mutate(ratio = round(decoration_types/sum, 2))

pre_deco <- pottery_deco_count$ratio[3]
post_deco <- pottery_deco_count$ratio[2]
chinese_deco <- pottery_deco_count$ratio[1]
```

# Discussion

<!-- a summary of results -->

Previous investigations at Kiwulan suggested an unequal distribution of prestige goods with high diversity in types, trade ornaments in particular, following the appearance of Europeans [@Cheng2008; @Wang2011]. This hinted at the emergence of social inequality within the Indigenous community. To understand the relationship between social inequality and foreign presences, we examined shape standardization of ceramics to measure craft specialization as a proxy for social change [@Costin2001; @Junker1999]. The result of our MANOVA demonstrates significant differences in shapes between the pre-European and Post-European periods, and pre-European and Chinese periods. The average shape presents as a round body with a wide rim and neck before European contact, which shifts to a more oval-shaped body with narrower rim and neck after the European presence. Such shape is more pronounced in the Chinese period. In general, vessels become oval-shaped with a restricted mouth over time, which corresponds with an increase in body diameter of vessels. The correlation between shape and body diameter suggests that body diameter significantly varies with vessel shape. Oval-shaped vessels with a narrower opening tended to have a larger body diameter, indicative of a change in overall vessel form. 

<!-- standardization and the issue of small sample size -->

For the degree of shape standardization, our CV tests on PC1 indicate a significant difference between the Chinese period and either pre-European or post-European periods. A test of morphological disparity also demonstrates similar results between Chinese contact and either pre-European (p = $`r pre_chi`$) or post-European periods (p= $`r post_chi`$) [@WangandMarwick2020], suggesting a more standardized shape after contact with the Chinese. In addition, we found a more homogeneous shape accompanied by a more standardized size, represented by the body diameter of vessels, in the Chinese period. Humans tend to make mistakes in hand-crafting when the size of an object increases, leading to higher variations in larger artifacts [@Eerkens2001]. However, it is opposite for the ceramics in the Chinese period when we use body diameter as our proxy variable of size. This might hint an intentional behavior to achieve a homogeneous form of vessels, but we still need more metric variables to assess the variation in size. Mineral composition shows that the clay pastes are similar throughout three phases, regardless of the increasing standardization of the pottery shape, reflecting continuity in the raw material sources. We can thus rule out changes in clay fabric as a factor in explaining changes in vessel shape. We note that a small sample size in the Chinese period may lead to a more standardized shape. However, this effect can be reduced using CV that scales variation to magnitude, allowing reliable comparison across uneven sample numbers, even for small sample size [@Eerkens2001]. Moreover, the MSLR test for equality of CVs enables a robust test between different sample numbers [@Krishnamoorthy2014].

<!-- does standardization reflect specialization? -->

Whether the shape standardization we found suggests craft specialization depends on the number of producers, which distinguishes mechanical standardization from intentional standardization defined by stylish and functional attributes [@Costin2001; @Costin1995]. Mechanical standardization is used to access the appearance of specialized production based on the assumption that increased skills, routinization, and lower diversity of producers will lead to morphological uniformity [@Arnold2000]. The population at Kiwulan could be an indicator to estimate the potential number of producers. According to the Dutch census in 1648 [@Nakamura1938, pp. 12], the population at Kiwulan was large but declined in the Chinese period due to the movement of Indigenous people to the south [@Chen2007]. The change in population size corresponds with the observation of ceramic abundance at Kiwulan. Thus, we model CV values as a function of the mass of ceramics using Poisson GLM with a link function. The model suggests that ceramic abundance strongly predicts the CV values (β = $`r beta_print`$, p = $`r pval_print`$). This indicates that a more standardized shape in the Chinese period may be influenced by a small population if ceramic abundance can reflect the population size.

However, intentional standardization due to considerations of function or style could also contribute to the shape standardization in our case. To ensure shape standardization can reflect craft specialization, we investigated the function and surface decoration of the vessels. For function, we used geochemical methods to extract and identify lipids trapped in the fabric of potsherds to explore foods that may have contributed residues absorbed into the clay [cf. @Kwak2015]. Unfortunately, we did not obtain useful results due to extremely low lipid yields, which is probably due to the very thin, dense, and low porosity fabric of Kiwulan pottery. These physical characteristics of the clay offer limited spaces to trap and protect organic molecules from microbiological degradation [cf. @Evershed2008, pp. 909]. For style, surface impressed decoration usually consists of multiple bands of geometric motifs that we define as one type of decoration. If two pots share the same set of motifs but different arrangements of single bands, they are considered as two types. In general, the ceramics in the Chinese period have slightly fewer variations in decoration according to the ratio of distinct types to the total number of pottery from each phase (Chinese = `r chinese_deco`, post-European = `r post_deco`, pre-European = `r pre_deco`) [@WangandMarwick2020]. The current evidence is not sufficient for us to completely rule out the possibility of intentional standardization.  

The spatial pattern of ceramics could provide information about potential production units and production areas [@Costin2001]. The spatial analysis (Figure \@ref(fig:kernel-plot)) reveals that pottery samples present a widespread distribution with high densities of pottery at some units during European presence. Hypothesis testing on spatial randomness indicates a non-randomly dispersed distribution before European contact and more extreme dispersed distribution after European presence. In contrast, the distribution of pottery is more similar to random distributions during the Chinese period. This contradicts our expectation that a clustered pattern will be observed with an increase in pottery standardization since the emergence of specialized groups [@Costin1995]. The absence of clusters in the Chinese period is notable because this was a time of a historically-documented decline of Indigenous population [@Chen2007; @Hsieh2009]. We might expect reduced numbers of potters to result in pottery production shrinking to a few locations in the settlement during this time. Despite the small number of vessels during the Chinese contact period, Figure \@ref(fig:kernel-plot) shows that pottery is distributed randomly across the sampling area without any distinctive clusters during this time. This suggests that differences in population across our three occupation phases are probably not driving variation in shape standardization. Also, it is more likely that ceramics are household-produced based on the spatial pattern and no specific facilities of production have been found [@Chen2007]. 

```{r pottery-spatial-pattern, fig.cap= "The spatial distribution of the pottery selected for shape analysis. The quantity is indicated by the color scale."}
library(sf)
library(viridis)

# read in the spatial data
AD_zone <- invisible(st_read(here("analysis", "data", "raw_data", "AD_zone.shp"), quiet = TRUE))
units_40 <- invisible(read.csv(here("analysis", "data", "raw_data", "kwl-list-of-sampling-squares.csv")))

AD_zone_tidy <-
  AD_zone %>% 
  mutate(Pit =paste0("P0",Id)) %>% 
  inner_join(units_40, by = c("Pit" = "the_sq")) %>% 
  select(Pit, geometry)

# tidy pottery data
pottery_count <-
  pottery_data %>% 
  select(Site, Context, Pit, Layer, No., phase) %>% 
  count(Pit, phase)

# join two dataset to get coordinate
pottery_count_join <-
  pottery_count %>%
  mutate(phase = as.factor(phase)) %>% # seems need this line first
  inner_join(AD_zone_tidy) %>% 
  filter(!is.na(phase)) %>% 
  mutate(phase = case_when(
    phase %in% "pre-e"~ "Before European\nContact",
    phase %in% "post-e" ~ "European Presence",
    phase %in% "ch-con" ~ "Chinese Presence")) %>% 
  mutate(phase = factor(phase,
                        level = c("Before European\nContact",
                                  "European Presence",
                                  "Chinese Presence")))
# plot spatial pattern for pottery
plot_spatial_distribution_pottery_by_phase <- 
  ggplot() +
  geom_sf(data = AD_zone_tidy, fill = NA) +
  geom_sf(data = pottery_count_join, 
          aes(geometry = geometry, 
              fill =n), 
          alpha = 0.9)+
  facet_wrap(~ phase) +
  labs(fill = "frequency") +
  scale_fill_viridis(direction = -1) +
  theme_minimal() +
  theme(panel.spacing = unit(3.5, "lines"),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        strip.text.x = element_text(size = 11),
       legend.text = element_text(size = 6),
       legend.title = element_text(size = 6, vjust = 0.75),
       legend.key.size =  unit(4, "mm"),
        legend.position = "top")


ggsave(plot = plot_spatial_distribution_pottery_by_phase,
       here("analysis", "figures",
            "plot-spatial-distribution-pottery-by-period.jpg"),
       width = 275, 
       height = 61,
       dpi = 300,
       units = "mm")
```

```{r kernel-plot, fig.cap= "A: The spatial distribution of the pottery selected for shape analysis. The quantity is indicated by the color scale. B: Kernel density map visulizes the probability of the density of pottery across space. The maps show a major core area during the pre-European period, multiple core areas during the European period, and a single core during the Chinese period. The bandwidth is based on Silverman (1986)"}

p1 <- ggdraw(clip = 'on') + 
  draw_image(here("analysis", "figures", "plot-spatial-distribution-pottery-by-period.jpg"), 
             scale = 1.6,
             x = -0.025)

# code for this is in the spatial_pattern.R script file
p2 <- ggdraw() + 
  draw_image(here("analysis", "figures", "plot-kde-maps.jpg"), 
             scale = 1)

plot_grid(p1, p2, ncol = 1, labels="AUTO")
ggsave(here("analysis/figures/kde-and-pottery-distribution-composite-plot.png"))
```

```{r Monte-Carlo-spatial-pattern, fig.cap= "Histograms of simulated average nearest-neighbour distances (ANN) values from 1000 simulations for three phases. X-axis values based on meteres represent ANN expected value. Each sample distribution presents the null hypothesis with the blue line indicating the observed ANN value", fig.width=3}

  image_resize(image_read( here("analysis", 
                                "figures", 
                                "plot-kde-ann-histograms.jpg")), 
               geometry_area(width = 1000))
                        
```

Our results offer tentative support for the hypothesis that foreign presence at Kiwulan influenced the shape of vessels in the local Indigenous society. If increased shape standardization is a reliable indicator of craft specialization, then we may be seeing evidence of a shift from corporate (group-based, distributed, collective, cooperative) to network (individual-based, competitive) organization [@Blanton1996; @Feinman1995; @Feinman2000; @Feinman2000political; @Feinman2010]. However, strong claims for an emergence of social inequality resulting from foreign contact at Kiwulan will need support from multiple and diverse sources of evidence that are beyond the scope of this paper. We find that vessel shapes were more standardized during the Chinese period than the European period.

Compared to other regions in Taiwan, European colonial influence was weak in Yilan due to isolation by the surrounding mountains, and the economic focus of the Spanish and Dutch who preferred northern and northwest Taiwan as their trading base [cf. @Berrocal2020]. Indigenous communities in Yilan experienced indirect influence from European trade networks and their colonial activities in a pericolonial context [cf. @Acabado2017]. In contrast to the Indigenous-European interactions at Kiwulan, the interaction between Indigenous people and Chinese immigrants in the 19th century appears to have been more intense and direct. Historical records indicate that Chinese groups settled in Yilan and lived closely with Kiwulan Indigenous societies [@Chen1963; @Ke1993]. This direct influence is reflected by the archaeological evidence of large amounts of Chinese porcelains and distinctive architectural bricks and tiles used by Chinese [@Hsieh2009]. Similarly, burials at Kiwulan in this later phase show the adoption of coffins in mortuary practices, which @Chiu2004 interprets as the adoption of a symbol of ethnic Chinese.

The shape variation reported here is subtle, and invites consideration of another possible scenario that the absence of major changes in vessel shape at Kiwulan may have been an act of resistance to foreign influence. We recognize the decline in population may lead to a standardized shape, however, the evidence of ceramic spatial distribution shows a dispersed or random pattern across the whole area throughout three phases. This indicates manufacturing activities may be limited to household scale and reflect a common practice in the community. The standardization in vessel shape over time draws our attention to the endurance of traditional pottery production practices amid intrusions from Europeans and Chinese. In a culture contact situation, social identity may be expressed through material practices as a means of expressing cultural homogeneity and distinction from other groups [@Voss2005]. 

It is also important to recognize that social identity might be more complicated in a colonial context, and maybe representative of more than a colonized–colonizer or local/foreign dichotomy [@Voss2005; @Voss2008]. Shamaoshan cemetery dating from BC 3 to AD 4 in Southwest China suggests that the process of the incorporation of Southwest China into the Han Empire involved a century of conflicts, resistance, and acceptance among social groups with different identities, especially in the historical context of Han immigrants [@Wu2019]. A similar dynamic may have occurred at Kiwulan, with vessel shape indicating both acceptance of foreign influence through increased shape standardization, and resistance through the overall continuity in vessel shape. Vessel shape can be viewed as a symbolic expression of the Indigenous identity and social boundaries because shape is a highly visible trait compared with other features of pottery [cf. @Roux2015]. Although there is an increase in number of imported ceramics through time at Kiwulan, production of local ceramics was continuous, and increasingly standardized. This might imply not only the utilitarian function, but an intentional and increased emphasis on the local ceramic tradition, their cultural custom, as a response to intensified foreign contact [cf. @Acabado2017]. However, we still need more lines of evidence to confirm this speculation of an act of resistance. 

# Conclusion

This study demonstrated the first use of EFA on ceramic shapes to explore the emergence of ceramic specialization as indicative of foreign influences. Here, EFA is combined with a significance test for the equality of CVs of shape variables to provide a robust method for assessing differences in shape standardization. The direct relationship between foreign influences and standardization of ceramic shape was tested on ceramics from Kiwulan, a large Iron Age Indigenous settlement in northeastern Taiwan. Much lower variation in ceramic shape was identified during the period of Chinese presence. Our findings help to expand upon those factors that may lead to the standardization of ceramic production in a pericolonial interaction context. More homogeneous vessel shapes and sizes during the Chinese period, without any substantial changes in clay paste composition, production technique, and spatial distribution, suggest that shape standardization may relate more to intentional behavior instead of the emergence of specialized groups. Despite a small sample size in the Chinese period, the random distribution of ceramics does not support clustered patterns of manufacturing location, such as workshops. Instead, the ceramic production is likely to be manufactured in households. The homogeneous appearance may suggest expressions of social identity or cultural boundaries in Indigenous societies through highly visible vessel qualities, such as shape, maybe heightened during periods of foreign contact in pericolonial contexts. Our analysis, with its openly available methods and data, is readily extensible to other pottery assemblages in the region to further explore related questions about craft specialization and standardization in Iron Age ceramic assemblages. This study also broadens the GMM field by focusing on ceramic technologies, which could motivate more ceramic studies and become a promising branch parallel to current applications to lithic typology and bone morphology. 

# Acknowledgments

We would like to thank the Yilan County Cultural Affairs Bureau in Taiwan for permitting access to the pottery used in this study and providing the shape images. We thank Dr. Wen-Shan Chen in the Department of Geosciences, National Taiwan University for his invaluable guidance of petrographic analysis at his lab. We thank the Quaternary Research Center funding for supporting the organic residue analysis in this project. We thank Dr. Julian Sachs in the Department of Oceanography, University of Washington for his supports and suggestions for conducting organic geochemistry analysis of potsherds. We thank Dr. Matthew Wolhowe for his help in developing protocols for lipid extraction and his assistance with the GC-MS, GC-FID, and GC-C-IRMS analyses. This research used statistical consulting resources provided by the Center for Statistics and the Social Sciences, University of Washington.

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```

Word count: `r wordcountaddin::word_count()`
